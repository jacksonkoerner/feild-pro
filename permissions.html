<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Setup - FieldVoice Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e1b4b 100%);
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        .pulse-ring::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid currentColor;
            animation: pulse-ring 1.5s ease-out infinite;
        }
        .check-item {
            transition: all 0.3s ease;
        }
        .check-item.success { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); }
        .check-item.error { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); }
        .check-item.warning { background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); }
        .check-item.testing { background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.3); }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="app" class="max-w-lg mx-auto min-h-screen flex flex-col p-6">

        <!-- Header -->
        <header class="text-center pt-6 pb-4">
            <div class="w-16 h-16 rounded-full bg-indigo-500/30 flex items-center justify-center mx-auto mb-3 animate-float">
                <i class="fas fa-shield-check text-indigo-300 text-2xl"></i>
            </div>
            <h1 class="text-2xl font-black text-white mb-1">App Setup</h1>
            <p class="text-white/60 text-sm">Let's make sure everything works</p>
        </header>

        <!-- Main Content -->
        <main class="flex-1 space-y-4">

            <!-- Voice Recording Section -->
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-5 border border-white/10">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 rounded-2xl bg-purple-500/20 flex items-center justify-center">
                        <i class="fas fa-microphone text-purple-400 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-white text-lg">Voice Recording</h3>
                        <p class="text-white/50 text-xs">Required for voice notes</p>
                    </div>
                </div>

                <!-- Sub-checks for voice -->
                <div class="space-y-2 mb-4">
                    <!-- Microphone Hardware -->
                    <div id="checkMicHardware" class="check-item flex items-center gap-3 p-3 rounded-xl border border-white/10 bg-white/5">
                        <div id="checkMicHardwareIcon" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fas fa-microphone-lines text-white/50 text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-white">Microphone Access</p>
                            <p id="checkMicHardwareStatus" class="text-xs text-white/50">Not tested</p>
                        </div>
                    </div>

                    <!-- Speech Recognition Service -->
                    <div id="checkSpeechService" class="check-item flex items-center gap-3 p-3 rounded-xl border border-white/10 bg-white/5">
                        <div id="checkSpeechServiceIcon" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fas fa-comment-dots text-white/50 text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-white">Speech Recognition</p>
                            <p id="checkSpeechServiceStatus" class="text-xs text-white/50">Not tested</p>
                        </div>
                    </div>
                </div>

                <button id="voiceTestBtn" onclick="testVoiceCapabilities()" class="w-full p-4 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-2xl transition-all active:scale-[0.98] flex items-center justify-center gap-3">
                    <i class="fas fa-play"></i>
                    <span>Test Voice Recording</span>
                </button>
            </div>

            <!-- iOS Siri/Dictation Instructions (shown when needed) -->
            <div id="siriInstructions" class="hidden bg-amber-500/10 backdrop-blur-sm rounded-3xl p-5 border border-amber-500/30">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded-xl bg-amber-500/20 flex items-center justify-center">
                        <i class="fab fa-apple text-amber-400 text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-amber-300">Enable Siri or Dictation</h3>
                        <p class="text-xs text-amber-200/70">Required for speech-to-text on iPhone</p>
                    </div>
                </div>

                <p class="text-sm text-white/70 mb-4">
                    Voice recording on iPhone uses Apple's speech recognition, which requires Siri or Dictation to be enabled.
                </p>

                <div class="bg-black/20 rounded-2xl p-4 mb-4">
                    <p class="text-xs font-bold text-amber-300 uppercase tracking-wider mb-3">Choose one option:</p>

                    <div class="space-y-3">
                        <div class="flex items-start gap-3">
                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-purple-500 text-white text-xs font-bold flex items-center justify-center">A</span>
                            <div>
                                <p class="text-sm text-white font-medium">Enable Siri</p>
                                <p class="text-xs text-white/60 mt-1">
                                    Settings → <strong class="text-amber-300">Siri & Search</strong> → Enable <strong class="text-emerald-400">"Listen for Hey Siri"</strong> or <strong class="text-emerald-400">"Press Side Button for Siri"</strong>
                                </p>
                            </div>
                        </div>

                        <div class="border-t border-white/10 pt-3">
                            <div class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-6 h-6 rounded-full bg-purple-500 text-white text-xs font-bold flex items-center justify-center">B</span>
                                <div>
                                    <p class="text-sm text-white font-medium">Enable Dictation</p>
                                    <p class="text-xs text-white/60 mt-1">
                                        Settings → <strong class="text-amber-300">General</strong> → <strong class="text-amber-300">Keyboard</strong> → Enable <strong class="text-emerald-400">"Enable Dictation"</strong>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="testVoiceCapabilities()" class="w-full p-4 bg-amber-500 hover:bg-amber-400 text-black font-bold rounded-2xl transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                    <i class="fas fa-rotate"></i>
                    <span>Test Again</span>
                </button>
            </div>

            <!-- Safari Microphone Permission Instructions -->
            <div id="safariMicInstructions" class="hidden bg-red-500/10 backdrop-blur-sm rounded-3xl p-5 border border-red-500/30">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center">
                        <i class="fab fa-safari text-red-400 text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-red-300">Allow Microphone Access</h3>
                        <p class="text-xs text-red-200/70">Browser permission required</p>
                    </div>
                </div>

                <div class="bg-black/20 rounded-2xl p-4 mb-4">
                    <div class="space-y-3">
                        <div class="flex items-start gap-3">
                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-500 text-white text-xs font-bold flex items-center justify-center">1</span>
                            <p class="text-sm text-white/90">Tap the <strong class="text-amber-300">"aA"</strong> button in Safari's address bar</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-500 text-white text-xs font-bold flex items-center justify-center">2</span>
                            <p class="text-sm text-white/90">Tap <strong class="text-amber-300">"Website Settings"</strong></p>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-500 text-white text-xs font-bold flex items-center justify-center">3</span>
                            <p class="text-sm text-white/90">Set <strong class="text-amber-300">Microphone</strong> to <strong class="text-emerald-400">"Allow"</strong></p>
                        </div>
                    </div>
                </div>

                <button onclick="testVoiceCapabilities()" class="w-full p-4 bg-red-500 hover:bg-red-400 text-white font-bold rounded-2xl transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                    <i class="fas fa-rotate"></i>
                    <span>Test Again</span>
                </button>
            </div>

            <!-- Location Section -->
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-5 border border-white/10">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 rounded-2xl bg-emerald-500/20 flex items-center justify-center">
                        <i class="fas fa-location-dot text-emerald-400 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-white text-lg">Location</h3>
                        <p class="text-white/50 text-xs">For weather & GPS tagging</p>
                    </div>
                </div>

                <!-- Sub-check for location -->
                <div class="space-y-2 mb-4">
                    <div id="checkLocation" class="check-item flex items-center gap-3 p-3 rounded-xl border border-white/10 bg-white/5">
                        <div id="checkLocationIcon" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fas fa-map-marker-alt text-white/50 text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-white">GPS Access</p>
                            <p id="checkLocationStatus" class="text-xs text-white/50">Not tested</p>
                        </div>
                    </div>
                </div>

                <button id="locationTestBtn" onclick="testLocation()" class="w-full p-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-2xl transition-all active:scale-[0.98] flex items-center justify-center gap-3">
                    <i class="fas fa-play"></i>
                    <span>Test Location</span>
                </button>
            </div>

            <!-- Overall Status -->
            <div id="overallStatus" class="bg-white/5 rounded-2xl p-4 border border-white/10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div id="overallIcon" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fas fa-clipboard-check text-white/50"></i>
                        </div>
                        <div>
                            <p class="font-bold text-white">Setup Status</p>
                            <p id="overallStatusText" class="text-xs text-white/50">Run tests to check</p>
                        </div>
                    </div>
                    <span id="overallBadge" class="px-3 py-1 rounded-full text-xs font-bold bg-white/10 text-white/50">Pending</span>
                </div>
            </div>

        </main>

        <!-- Footer Actions -->
        <footer class="pt-4 pb-4 space-y-3">
            <button id="continueBtn" onclick="continueToApp()" class="w-full p-5 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold rounded-3xl shadow-lg shadow-indigo-500/30 transition-all hover:shadow-indigo-500/50 active:scale-[0.98] flex items-center justify-center gap-3 disabled:opacity-50">
                <span id="continueBtnText">Continue to App</span>
                <i class="fas fa-arrow-right"></i>
            </button>
            <button onclick="skipSetup()" class="w-full p-3 text-white/40 hover:text-white/70 text-sm font-medium transition-colors">
                Skip for now (limited features)
            </button>
        </footer>

    </div>

    <script>
        // ============ BROWSER DETECTION ============
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOSSafari = isIOS && isSafari;
        const isAndroid = /Android/.test(navigator.userAgent);

        // ============ TEST STATE ============
        let testResults = {
            microphoneHardware: null,  // 'success', 'error', 'denied', null
            speechRecognition: null,
            location: null
        };

        // ============ TEST VOICE CAPABILITIES ============
        async function testVoiceCapabilities() {
            const btn = document.getElementById('voiceTestBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Testing...</span>';

            // Hide any existing instruction panels
            document.getElementById('siriInstructions').classList.add('hidden');
            document.getElementById('safariMicInstructions').classList.add('hidden');

            // Test 1: Microphone Hardware
            updateCheckItem('checkMicHardware', 'testing', 'Testing microphone access...');
            const micResult = await testMicrophoneHardware();

            if (!micResult.success) {
                testResults.microphoneHardware = micResult.error;
                updateCheckItem('checkMicHardware', 'error', micResult.message);

                // Show Safari instructions if permission denied
                if (micResult.error === 'denied' && isIOSSafari) {
                    document.getElementById('safariMicInstructions').classList.remove('hidden');
                }

                // Can't test speech if mic failed
                updateCheckItem('checkSpeechService', 'error', 'Requires microphone access');
                testResults.speechRecognition = 'blocked';

                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-redo"></i><span>Test Again</span>';
                updateOverallStatus();
                return;
            }

            testResults.microphoneHardware = 'success';
            updateCheckItem('checkMicHardware', 'success', 'Microphone working');
            localStorage.setItem('fvp_mic_granted', 'true');
            localStorage.setItem('fvp_mic_tested', new Date().toISOString());

            // Test 2: Speech Recognition Service
            updateCheckItem('checkSpeechService', 'testing', 'Testing speech recognition...');
            const speechResult = await testSpeechRecognition();

            if (!speechResult.success) {
                testResults.speechRecognition = speechResult.error;
                updateCheckItem('checkSpeechService', 'error', speechResult.message);

                // Show Siri instructions on iOS
                if (isIOS && speechResult.error === 'service-not-allowed') {
                    document.getElementById('siriInstructions').classList.remove('hidden');
                    // Scroll to instructions
                    setTimeout(() => {
                        document.getElementById('siriInstructions').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }

                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-redo"></i><span>Test Again</span>';
                updateOverallStatus();
                return;
            }

            testResults.speechRecognition = 'success';
            updateCheckItem('checkSpeechService', 'success', 'Speech recognition working');
            localStorage.setItem('fvp_speech_tested', new Date().toISOString());

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check-circle"></i><span>Voice Recording Ready</span>';
            btn.className = 'w-full p-4 bg-emerald-500/30 text-emerald-300 font-bold rounded-2xl flex items-center justify-center gap-3 cursor-default';

            showToast('Voice recording is ready!', 'success');
            updateOverallStatus();
        }

        // Test microphone hardware access
        async function testMicrophoneHardware() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    return { success: false, error: 'unsupported', message: 'Browser doesn\'t support microphone' };
                }

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: true, noiseSuppression: true }
                });

                const audioTracks = stream.getAudioTracks();
                if (audioTracks.length === 0) {
                    stream.getTracks().forEach(track => track.stop());
                    return { success: false, error: 'no-device', message: 'No microphone found' };
                }

                const track = audioTracks[0];
                console.log('[Mic Test] Track:', track.label, track.readyState);

                if (track.muted || track.readyState !== 'live') {
                    stream.getTracks().forEach(track => track.stop());
                    return { success: false, error: 'not-working', message: 'Microphone not responding' };
                }

                // Success - stop stream
                stream.getTracks().forEach(track => track.stop());
                return { success: true };

            } catch (err) {
                console.error('[Mic Test] Error:', err.name, err.message);

                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    return { success: false, error: 'denied', message: 'Microphone access blocked' };
                } else if (err.name === 'NotFoundError') {
                    return { success: false, error: 'no-device', message: 'No microphone found' };
                } else if (err.name === 'NotReadableError') {
                    return { success: false, error: 'in-use', message: 'Microphone in use by another app' };
                } else {
                    return { success: false, error: 'unknown', message: err.message || 'Unknown error' };
                }
            }
        }

        // Test speech recognition service
        async function testSpeechRecognition() {
            return new Promise((resolve) => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

                if (!SpeechRecognition) {
                    resolve({ success: false, error: 'unsupported', message: 'Speech recognition not supported' });
                    return;
                }

                const recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                let resolved = false;
                const timeout = setTimeout(() => {
                    if (!resolved) {
                        resolved = true;
                        recognition.abort();
                        // If we got this far without error, it's probably working
                        // The timeout just means no speech was detected
                        resolve({ success: true });
                    }
                }, 2000);

                recognition.onstart = () => {
                    console.log('[Speech Test] Started successfully');
                    // If it starts, the service is working
                    clearTimeout(timeout);
                    if (!resolved) {
                        resolved = true;
                        recognition.stop();
                        resolve({ success: true });
                    }
                };

                recognition.onerror = (event) => {
                    console.error('[Speech Test] Error:', event.error);
                    clearTimeout(timeout);
                    if (!resolved) {
                        resolved = true;

                        if (event.error === 'service-not-allowed' || event.error === 'not-allowed') {
                            resolve({
                                success: false,
                                error: 'service-not-allowed',
                                message: isIOS ? 'Enable Siri or Dictation in Settings' : 'Speech service blocked'
                            });
                        } else if (event.error === 'network') {
                            resolve({ success: false, error: 'network', message: 'No internet connection' });
                        } else if (event.error === 'audio-capture') {
                            resolve({ success: false, error: 'audio-capture', message: 'Audio capture failed' });
                        } else if (event.error === 'no-speech') {
                            // No speech is fine - the service works
                            resolve({ success: true });
                        } else {
                            resolve({ success: false, error: event.error, message: 'Speech recognition error' });
                        }
                    }
                };

                recognition.onend = () => {
                    clearTimeout(timeout);
                    if (!resolved) {
                        resolved = true;
                        resolve({ success: true });
                    }
                };

                try {
                    recognition.start();
                } catch (err) {
                    clearTimeout(timeout);
                    resolved = true;
                    resolve({ success: false, error: 'start-failed', message: 'Could not start speech recognition' });
                }
            });
        }

        // ============ TEST LOCATION ============
        async function testLocation() {
            const btn = document.getElementById('locationTestBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Testing...</span>';

            updateCheckItem('checkLocation', 'testing', 'Getting location...');

            try {
                if (!navigator.geolocation) {
                    throw { code: -1, message: 'Geolocation not supported' };
                }

                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });

                console.log('[Location Test] Success:', position.coords.latitude, position.coords.longitude);

                testResults.location = 'success';
                updateCheckItem('checkLocation', 'success', `Location found (±${Math.round(position.coords.accuracy)}m)`);
                localStorage.setItem('fvp_loc_granted', 'true');
                localStorage.setItem('fvp_loc_tested', new Date().toISOString());

                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle"></i><span>Location Ready</span>';
                btn.className = 'w-full p-4 bg-emerald-500/30 text-emerald-300 font-bold rounded-2xl flex items-center justify-center gap-3 cursor-default';

                showToast('Location access working!', 'success');

            } catch (err) {
                console.error('[Location Test] Error:', err.code, err.message);

                let message = 'Location error';
                if (err.code === 1) {
                    message = 'Location access denied';
                    testResults.location = 'denied';
                    localStorage.removeItem('fvp_loc_granted');
                } else if (err.code === 2) {
                    message = 'Location unavailable';
                    testResults.location = 'unavailable';
                } else if (err.code === 3) {
                    message = 'Location timed out';
                    testResults.location = 'timeout';
                } else {
                    testResults.location = 'error';
                }

                updateCheckItem('checkLocation', 'error', message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-redo"></i><span>Test Again</span>';
            }

            updateOverallStatus();
        }

        // ============ UI HELPERS ============
        function updateCheckItem(id, status, message) {
            const item = document.getElementById(id);
            const icon = document.getElementById(id + 'Icon');
            const statusText = document.getElementById(id + 'Status');

            // Remove existing status classes
            item.classList.remove('success', 'error', 'warning', 'testing');

            switch (status) {
                case 'success':
                    item.classList.add('success');
                    icon.innerHTML = '<i class="fas fa-check text-emerald-400 text-sm"></i>';
                    icon.className = 'w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center';
                    statusText.className = 'text-xs text-emerald-400';
                    break;
                case 'error':
                    item.classList.add('error');
                    icon.innerHTML = '<i class="fas fa-times text-red-400 text-sm"></i>';
                    icon.className = 'w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center';
                    statusText.className = 'text-xs text-red-400';
                    break;
                case 'warning':
                    item.classList.add('warning');
                    icon.innerHTML = '<i class="fas fa-exclamation text-amber-400 text-sm"></i>';
                    icon.className = 'w-8 h-8 rounded-full bg-amber-500/20 flex items-center justify-center';
                    statusText.className = 'text-xs text-amber-400';
                    break;
                case 'testing':
                    item.classList.add('testing');
                    icon.innerHTML = '<i class="fas fa-spinner fa-spin text-indigo-400 text-sm"></i>';
                    icon.className = 'w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center';
                    statusText.className = 'text-xs text-indigo-400';
                    break;
            }

            statusText.textContent = message;
        }

        function updateOverallStatus() {
            const icon = document.getElementById('overallIcon');
            const text = document.getElementById('overallStatusText');
            const badge = document.getElementById('overallBadge');
            const container = document.getElementById('overallStatus');

            const voiceReady = testResults.microphoneHardware === 'success' && testResults.speechRecognition === 'success';
            const locationReady = testResults.location === 'success';
            const hasErrors = testResults.microphoneHardware && testResults.microphoneHardware !== 'success' ||
                             testResults.speechRecognition && testResults.speechRecognition !== 'success' ||
                             testResults.location && testResults.location !== 'success';

            if (voiceReady && locationReady) {
                container.className = 'bg-emerald-500/10 rounded-2xl p-4 border border-emerald-500/30';
                icon.innerHTML = '<i class="fas fa-check-circle text-emerald-400"></i>';
                icon.className = 'w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center';
                text.textContent = 'All features ready!';
                text.className = 'text-xs text-emerald-400';
                badge.textContent = 'Ready';
                badge.className = 'px-3 py-1 rounded-full text-xs font-bold bg-emerald-500 text-white';
            } else if (voiceReady) {
                container.className = 'bg-amber-500/10 rounded-2xl p-4 border border-amber-500/30';
                icon.innerHTML = '<i class="fas fa-check text-amber-400"></i>';
                icon.className = 'w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center';
                text.textContent = 'Voice ready, location pending';
                text.className = 'text-xs text-amber-400';
                badge.textContent = 'Partial';
                badge.className = 'px-3 py-1 rounded-full text-xs font-bold bg-amber-500 text-black';
            } else if (hasErrors) {
                container.className = 'bg-red-500/10 rounded-2xl p-4 border border-red-500/30';
                icon.innerHTML = '<i class="fas fa-exclamation-triangle text-red-400"></i>';
                icon.className = 'w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center';
                text.textContent = 'Some features need setup';
                text.className = 'text-xs text-red-400';
                badge.textContent = 'Issues';
                badge.className = 'px-3 py-1 rounded-full text-xs font-bold bg-red-500 text-white';
            }
        }

        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();

            const colors = {
                success: 'bg-emerald-600',
                error: 'bg-red-600',
                warning: 'bg-amber-600'
            };

            const toast = document.createElement('div');
            toast.className = `toast-notification fixed bottom-24 left-1/2 -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-full font-bold text-sm shadow-lg z-50 flex items-center gap-2`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'exclamation'}"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============ NAVIGATION ============
        function continueToApp() {
            localStorage.setItem('fvp_onboarded', 'true');
            window.location.href = 'index.html';
        }

        function skipSetup() {
            localStorage.setItem('fvp_onboarded', 'true');
            localStorage.setItem('fvp_skipped_permissions', 'true');
            window.location.href = 'index.html';
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => {
            // Check if we have previous test results
            const micTested = localStorage.getItem('fvp_mic_tested');
            const speechTested = localStorage.getItem('fvp_speech_tested');
            const locTested = localStorage.getItem('fvp_loc_tested');

            // If previously tested and passed, show success states
            if (micTested && localStorage.getItem('fvp_mic_granted') === 'true') {
                testResults.microphoneHardware = 'success';
                updateCheckItem('checkMicHardware', 'success', 'Microphone working');
            }

            if (speechTested) {
                testResults.speechRecognition = 'success';
                updateCheckItem('checkSpeechService', 'success', 'Speech recognition working');

                const btn = document.getElementById('voiceTestBtn');
                btn.innerHTML = '<i class="fas fa-check-circle"></i><span>Voice Recording Ready</span>';
                btn.className = 'w-full p-4 bg-emerald-500/30 text-emerald-300 font-bold rounded-2xl flex items-center justify-center gap-3';
            }

            if (locTested && localStorage.getItem('fvp_loc_granted') === 'true') {
                testResults.location = 'success';
                updateCheckItem('checkLocation', 'success', 'Location enabled');

                const btn = document.getElementById('locationTestBtn');
                btn.innerHTML = '<i class="fas fa-check-circle"></i><span>Location Ready</span>';
                btn.className = 'w-full p-4 bg-emerald-500/30 text-emerald-300 font-bold rounded-2xl flex items-center justify-center gap-3';
            }

            updateOverallStatus();
        });
    </script>
</body>
</html>
