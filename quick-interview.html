<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quick Report - FieldVoice Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes pulse-recording {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.5); opacity: 0; }
        }
        .recording-pulse::before {
            content: '';
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse-recording 1.5s ease-out infinite;
        }
        .section-card {
            transition: all 0.3s ease;
        }
        .section-card.expanded {
            border-color: rgb(99 102 241 / 0.5);
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
        }
        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .section-card.expanded .section-content {
            max-height: 1000px;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Microphone button states */
        .voice-btn.mic-testing {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            animation: pulse 1.5s ease-in-out infinite;
        }
        .voice-btn.mic-working {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .voice-btn.mic-denied {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            cursor: pointer;
        }
        .voice-btn.mic-error {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            cursor: pointer;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.95); }
        }
    </style>
</head>
<body class="bg-slate-900 min-h-screen text-white">
    <div id="app" class="max-w-lg mx-auto min-h-screen flex flex-col">

        <!-- Permissions Warning Banner -->
        <div id="permissionsWarningBanner" class="hidden bg-amber-500/90 backdrop-blur-sm">
            <div class="px-4 py-3 flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-white"></i>
                <p class="flex-1 text-sm text-white font-medium">Some features require permissions</p>
                <a href="permissions.html" class="px-3 py-1.5 bg-white text-amber-600 font-bold text-xs rounded-lg">
                    Enable
                </a>
                <button onclick="dismissWarningBanner()" class="text-white/70 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- HEADER -->
        <header class="sticky top-0 z-20 bg-slate-900/95 backdrop-blur-sm p-4 border-b border-white/10">
            <div class="flex items-center justify-between">
                <a href="index.html" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 transition-colors">
                    <i class="fas fa-arrow-left text-white/70"></i>
                </a>
                <div class="text-center flex-1 mx-4">
                    <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest">Quick Report</p>
                    <p id="currentDate" class="text-sm font-medium text-white/70"></p>
                </div>
                <button onclick="finishReport()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold rounded-xl transition-colors">
                    Finish
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="mt-3 flex items-center gap-2">
                <div class="flex-1 h-1.5 bg-white/10 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-gradient-to-r from-emerald-500 to-teal-500 transition-all duration-500" style="width: 0%"></div>
                </div>
                <span id="progressText" class="text-xs text-white/50">0%</span>
            </div>
        </header>

        <!-- SECTIONS LIST -->
        <main class="flex-1 p-4 pb-8 space-y-3 overflow-y-auto hide-scrollbar">

            <!-- Weather Section -->
            <div class="section-card bg-white/5 rounded-2xl border border-white/10" data-section="weather">
                <button onclick="toggleSection('weather')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-sky-500/20 flex items-center justify-center">
                        <i class="fas fa-cloud-sun text-sky-400 text-xl"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-white">Weather & Site Conditions</p>
                        <p id="weather-preview" class="text-sm text-white/50 truncate">Tap to add</p>
                    </div>
                    <div id="weather-status" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-white/30 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3">
                        <div class="bg-white/5 rounded-xl p-3">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-white/50">Condition</span>
                                <span id="weather-condition" class="font-bold text-white">--</span>
                            </div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-white/50">Temperature</span>
                                <span id="weather-temp" class="font-bold text-white">--</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-white/50">Precipitation</span>
                                <span id="weather-precip" class="font-bold text-white">--</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Site Conditions</label>
                            <div class="mt-2 flex items-center gap-2">
                                <textarea id="site-conditions-input" class="flex-1 bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder-white/30 focus:outline-none focus:border-indigo-500 resize-none" rows="2" placeholder="Describe site conditions..."></textarea>
                                <button onclick="recordVoice('weather')" class="voice-btn w-12 h-12 rounded-full bg-indigo-600 hover:bg-indigo-500 flex items-center justify-center text-white transition-all">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Work Summary Section -->
            <div class="section-card bg-white/5 rounded-2xl border border-white/10" data-section="activities">
                <button onclick="toggleSection('activities')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center">
                        <i class="fas fa-tasks text-emerald-400 text-xl"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-white">Work Summary</p>
                        <p id="activities-preview" class="text-sm text-white/50 truncate">Tap to add</p>
                    </div>
                    <div id="activities-status" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-white/30 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3">
                        <div id="activities-list" class="space-y-2">
                            <!-- Dynamic activities -->
                        </div>
                        <div class="flex items-center gap-2">
                            <textarea id="activity-input" class="flex-1 bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder-white/30 focus:outline-none focus:border-indigo-500 resize-none" rows="2" placeholder="Describe work performed..."></textarea>
                            <button onclick="addActivity()" class="px-4 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="recordVoice('activities')" class="voice-btn w-12 h-12 rounded-full bg-indigo-600 hover:bg-indigo-500 flex items-center justify-center text-white transition-all">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Issues Section -->
            <div class="section-card bg-white/5 rounded-2xl border border-white/10" data-section="issues">
                <button onclick="toggleSection('issues')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-400 text-xl"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-white">Issues & Delays</p>
                        <p id="issues-preview" class="text-sm text-white/50 truncate">None reported</p>
                    </div>
                    <div id="issues-status" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-white/30 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3">
                        <button onclick="markNA('issues')" id="issues-na-btn" class="w-full p-3 bg-white/5 border border-white/20 rounded-xl text-white/60 hover:bg-white/10 hover:text-white transition-colors text-sm font-medium">
                            <i class="fas fa-ban mr-2"></i>No Issues - Mark as N/A
                        </button>
                        <div id="issues-list" class="space-y-2">
                            <!-- Dynamic issues -->
                        </div>
                        <div class="flex items-center gap-2">
                            <textarea id="issue-input" class="flex-1 bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder-white/30 focus:outline-none focus:border-indigo-500 resize-none" rows="2" placeholder="Describe any issues or delays..."></textarea>
                            <button onclick="addIssue()" class="px-4 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="recordVoice('issues')" class="voice-btn w-12 h-12 rounded-full bg-indigo-600 hover:bg-indigo-500 flex items-center justify-center text-white transition-all">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inspections Section -->
            <div class="section-card bg-white/5 rounded-2xl border border-white/10" data-section="inspections">
                <button onclick="toggleSection('inspections')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
                        <i class="fas fa-check-double text-purple-400 text-xl"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-white">QA/QC Inspections</p>
                        <p id="inspections-preview" class="text-sm text-white/50 truncate">None reported</p>
                    </div>
                    <div id="inspections-status" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-white/30 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3">
                        <button onclick="markNA('inspections')" id="inspections-na-btn" class="w-full p-3 bg-white/5 border border-white/20 rounded-xl text-white/60 hover:bg-white/10 hover:text-white transition-colors text-sm font-medium">
                            <i class="fas fa-ban mr-2"></i>No Inspections - Mark as N/A
                        </button>
                        <div id="inspections-list" class="space-y-2">
                            <!-- Dynamic inspections -->
                        </div>
                        <div class="flex items-center gap-2">
                            <textarea id="inspection-input" class="flex-1 bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder-white/30 focus:outline-none focus:border-indigo-500 resize-none" rows="2" placeholder="Describe inspections or testing..."></textarea>
                            <button onclick="addInspection()" class="px-4 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="recordVoice('inspections')" class="voice-btn w-12 h-12 rounded-full bg-indigo-600 hover:bg-indigo-500 flex items-center justify-center text-white transition-all">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Safety Section -->
            <div class="section-card bg-white/5 rounded-2xl border border-white/10" data-section="safety">
                <button onclick="toggleSection('safety')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center">
                        <i class="fas fa-hard-hat text-green-400 text-xl"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-white">Safety</p>
                        <p id="safety-preview" class="text-sm text-white/50 truncate">No incidents</p>
                    </div>
                    <div id="safety-status" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-white/30 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3">
                        <div class="flex gap-2">
                            <label class="flex-1 flex items-center gap-3 p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-xl cursor-pointer hover:bg-emerald-500/20 transition-colors">
                                <input type="checkbox" id="no-incidents" class="w-5 h-5 rounded text-emerald-600 focus:ring-emerald-500">
                                <span class="font-medium text-emerald-400">No incidents</span>
                            </label>
                            <label class="flex-1 flex items-center gap-3 p-3 bg-red-500/10 border border-red-500/30 rounded-xl cursor-pointer hover:bg-red-500/20 transition-colors">
                                <input type="checkbox" id="has-incidents" class="w-5 h-5 rounded text-red-600 focus:ring-red-500">
                                <span class="font-medium text-red-400">Incident occurred</span>
                            </label>
                        </div>
                        <div id="safety-list" class="space-y-2">
                            <!-- Dynamic safety notes -->
                        </div>
                        <div class="flex items-center gap-2">
                            <textarea id="safety-input" class="flex-1 bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder-white/30 focus:outline-none focus:border-indigo-500 resize-none" rows="2" placeholder="Safety notes, toolbox talks..."></textarea>
                            <button onclick="addSafetyNote()" class="px-4 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="recordVoice('safety')" class="voice-btn w-12 h-12 rounded-full bg-indigo-600 hover:bg-indigo-500 flex items-center justify-center text-white transition-all">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visitors Section -->
            <div class="section-card bg-white/5 rounded-2xl border border-white/10" data-section="visitors">
                <button onclick="toggleSection('visitors')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-indigo-500/20 flex items-center justify-center">
                        <i class="fas fa-user-tie text-indigo-400 text-xl"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-white">Visitors & Communications</p>
                        <p id="visitors-preview" class="text-sm text-white/50 truncate">None reported</p>
                    </div>
                    <div id="visitors-status" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-white/30 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3">
                        <button onclick="markNA('visitors')" id="visitors-na-btn" class="w-full p-3 bg-white/5 border border-white/20 rounded-xl text-white/60 hover:bg-white/10 hover:text-white transition-colors text-sm font-medium">
                            <i class="fas fa-ban mr-2"></i>No Visitors - Mark as N/A
                        </button>
                        <div id="visitors-list" class="space-y-2">
                            <!-- Dynamic visitors -->
                        </div>
                        <div class="flex items-center gap-2">
                            <textarea id="visitor-input" class="flex-1 bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder-white/30 focus:outline-none focus:border-indigo-500 resize-none" rows="2" placeholder="Visitors, calls, communications..."></textarea>
                            <button onclick="addVisitor()" class="px-4 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="recordVoice('visitors')" class="voice-btn w-12 h-12 rounded-full bg-indigo-600 hover:bg-indigo-500 flex items-center justify-center text-white transition-all">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Photos Section -->
            <div class="section-card bg-white/5 rounded-2xl border border-white/10" data-section="photos">
                <button onclick="toggleSection('photos')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-pink-500/20 flex items-center justify-center">
                        <i class="fas fa-camera text-pink-400 text-xl"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-white">Progress Photos</p>
                        <p id="photos-preview" class="text-sm text-white/50 truncate">No photos</p>
                    </div>
                    <div id="photos-status" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-white/30 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3">
                        <label class="block cursor-pointer">
                            <input type="file" accept="image/*" capture="environment" multiple class="hidden" id="photoInput">
                            <div class="border-2 border-dashed border-white/20 rounded-xl p-6 text-center hover:border-pink-400/50 hover:bg-pink-500/5 transition-colors">
                                <i class="fas fa-camera text-2xl text-white/30 mb-2"></i>
                                <p class="font-bold text-white/70">Tap to add photos</p>
                                <p class="text-xs text-white/40">GPS location will be captured</p>
                            </div>
                        </label>
                        <div id="photos-grid" class="grid grid-cols-2 gap-2">
                            <!-- Dynamic photos -->
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Voice Recording Modal -->
    <div id="voiceModal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-3xl w-full max-w-sm p-6">
            <div class="text-center mb-6">
                <p id="voiceModalTitle" class="text-lg font-bold text-white">Recording...</p>
                <p class="text-sm text-white/50">Tap stop when finished</p>
            </div>

            <div id="voiceTranscript" class="bg-white/10 rounded-2xl p-4 mb-6 min-h-[100px] max-h-[200px] overflow-y-auto">
                <p id="liveTranscript" class="text-sm text-white/80 italic">Listening...</p>
            </div>

            <div class="flex justify-center gap-4">
                <button onclick="cancelVoice()" class="px-6 py-3 bg-white/10 text-white font-bold rounded-xl hover:bg-white/20 transition-colors">
                    Cancel
                </button>
                <button id="stopVoiceBtn" onclick="stopVoice()" class="recording-pulse relative px-6 py-3 bg-red-500 text-white font-bold rounded-xl">
                    <i class="fas fa-stop mr-2"></i>Stop
                </button>
            </div>
        </div>
    </div>

    <!-- Permissions Setup Modal -->
    <div id="permissionsModal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-3xl w-full max-w-sm p-6 border border-white/20">
            <div class="text-center mb-6">
                <div class="w-16 h-16 rounded-full bg-indigo-500/20 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-check text-indigo-400 text-2xl"></i>
                </div>
                <p class="text-xl font-bold text-white">Enable Permissions</p>
                <p class="text-sm text-white/50 mt-1">Required for voice recording & weather</p>
            </div>

            <div class="space-y-3 mb-6">
                <!-- Microphone Permission -->
                <div id="micPermissionRow" class="bg-white/5 rounded-xl p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center">
                                <i class="fas fa-microphone text-purple-400"></i>
                            </div>
                            <div>
                                <p class="font-bold text-white text-sm">Microphone</p>
                                <p id="micPermissionStatus" class="text-xs text-white/50">For voice notes</p>
                            </div>
                        </div>
                        <button id="micPermissionBtn" onclick="requestMicrophonePermission()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold rounded-lg transition-colors">
                            Enable
                        </button>
                    </div>
                </div>

                <!-- Location Permission -->
                <div id="locPermissionRow" class="bg-white/5 rounded-xl p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center">
                                <i class="fas fa-location-dot text-emerald-400"></i>
                            </div>
                            <div>
                                <p class="font-bold text-white text-sm">Location</p>
                                <p id="locPermissionStatus" class="text-xs text-white/50">For weather & GPS</p>
                            </div>
                        </div>
                        <button id="locPermissionBtn" onclick="requestLocationPermission()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded-lg transition-colors">
                            Enable
                        </button>
                    </div>
                </div>
            </div>

            <button id="permissionsContinueBtn" onclick="closePermissionsModal()" class="w-full p-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl transition-colors">
                Continue
            </button>
            <button onclick="closePermissionsModal()" class="w-full p-3 text-white/50 hover:text-white text-sm font-medium transition-colors mt-2">
                Skip for now
            </button>
        </div>
    </div>

    <script>
        // ============ STATE ============
        let currentSection = null;
        let isRecording = false;
        let recognition = null;
        let currentTranscript = '';
        let activeVoiceSection = null;
        let report = null;
        let permissionsChecked = false;

        // ============ MICROPHONE STATE ============
        let microphoneState = {
            status: 'unknown',  // 'unknown', 'testing', 'working', 'error', 'denied', 'unavailable'
            lastError: null,
            lastTested: null,
            audioStream: null
        };

        // ============ BROWSER DETECTION ============
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOSSafari = isIOS && isSafari;
        const isAndroid = /Android/.test(navigator.userAgent);
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        // ============ MICROPHONE ERROR DEFINITIONS ============
        const MIC_ERRORS = {
            // getUserMedia errors
            'NotAllowedError': {
                title: 'Microphone Blocked',
                message: 'Browser blocked microphone access.',
                recovery: 'Check browser permissions in settings.',
                icon: 'fa-microphone-slash',
                severity: 'denied'
            },
            'PermissionDeniedError': {
                title: 'Permission Denied',
                message: 'You denied microphone permission.',
                recovery: 'Tap settings to allow microphone access.',
                icon: 'fa-lock',
                severity: 'denied'
            },
            'NotFoundError': {
                title: 'No Microphone Found',
                message: 'No microphone detected on this device.',
                recovery: 'Connect a microphone or check device settings.',
                icon: 'fa-microphone-slash',
                severity: 'unavailable'
            },
            'NotReadableError': {
                title: 'Microphone In Use',
                message: 'Another app is using the microphone.',
                recovery: 'Close other apps using the mic and try again.',
                icon: 'fa-ban',
                severity: 'error'
            },
            'OverconstrainedError': {
                title: 'Microphone Error',
                message: 'Microphone doesn\'t meet requirements.',
                recovery: 'Try a different microphone.',
                icon: 'fa-exclamation-triangle',
                severity: 'error'
            },
            'AbortError': {
                title: 'Request Cancelled',
                message: 'Microphone request was cancelled.',
                recovery: 'Try again.',
                icon: 'fa-times-circle',
                severity: 'error'
            },
            'SecurityError': {
                title: 'Security Error',
                message: 'Page must use HTTPS for microphone.',
                recovery: 'Access this site via HTTPS.',
                icon: 'fa-shield-halved',
                severity: 'error'
            },
            'TypeError': {
                title: 'Browser Error',
                message: 'Browser doesn\'t support audio capture.',
                recovery: 'Try Chrome or Safari.',
                icon: 'fa-browser',
                severity: 'unavailable'
            },
            // SpeechRecognition errors
            'not-allowed': {
                title: 'Speech Recognition Blocked',
                message: 'Microphone access was denied.',
                recovery: 'Enable microphone in browser settings.',
                icon: 'fa-microphone-slash',
                severity: 'denied'
            },
            'service-not-allowed': {
                title: isIOS ? 'Enable Siri or Dictation' : 'Service Blocked',
                message: isIOS ? 'Speech recognition requires Siri or Dictation to be enabled on your iPhone.' : 'Speech recognition service is blocked.',
                recovery: isIOS
                    ? 'Go to Settings → Siri & Search → Enable "Listen for Hey Siri" OR Settings → General → Keyboard → Enable Dictation'
                    : 'Check browser settings or try a different browser.',
                icon: isIOS ? 'fa-microphone-lines' : 'fa-cloud-slash',
                severity: 'error',
                isIOSSpecific: isIOS
            },
            'audio-capture': {
                title: 'Audio Capture Failed',
                message: 'Could not capture audio from microphone.',
                recovery: 'Check microphone connection and try again.',
                icon: 'fa-volume-xmark',
                severity: 'error'
            },
            'network': {
                title: 'Network Error',
                message: 'Speech recognition needs internet.',
                recovery: 'Check your internet connection.',
                icon: 'fa-wifi-slash',
                severity: 'error'
            },
            'aborted': {
                title: 'Recording Stopped',
                message: 'Speech recognition was stopped.',
                recovery: 'Tap the microphone to try again.',
                icon: 'fa-stop-circle',
                severity: 'info'
            },
            'language-not-supported': {
                title: 'Language Not Supported',
                message: 'English speech recognition unavailable.',
                recovery: 'Try a different browser.',
                icon: 'fa-language',
                severity: 'error'
            },
            'no-speech': {
                title: 'No Speech Detected',
                message: 'Didn\'t hear anything.',
                recovery: 'Speak clearly into the microphone.',
                icon: 'fa-volume-off',
                severity: 'info'
            },
            'bad-grammar': {
                title: 'Recognition Error',
                message: 'Could not understand speech.',
                recovery: 'Speak more clearly and try again.',
                icon: 'fa-comment-slash',
                severity: 'info'
            }
        };

        // Default error for unknown cases
        const DEFAULT_MIC_ERROR = {
            title: 'Microphone Error',
            message: 'Something went wrong with the microphone.',
            recovery: 'Try again or restart the app.',
            icon: 'fa-exclamation-circle',
            severity: 'error'
        };

        // ============ MICROPHONE TESTING ============
        // Get detailed error info from error name/type
        function getMicrophoneErrorInfo(errorName) {
            return MIC_ERRORS[errorName] || DEFAULT_MIC_ERROR;
        }

        // Test if microphone actually works by attempting to capture audio
        async function testMicrophone(showUI = true) {
            console.log('[Mic Test] Starting microphone test...');
            microphoneState.status = 'testing';
            microphoneState.lastTested = new Date().toISOString();

            if (showUI) {
                updateMicrophoneStatusUI('testing');
            }

            try {
                // Check if getUserMedia is supported
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw { name: 'TypeError', message: 'getUserMedia not supported' };
                }

                // Try to get audio stream
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                // Check if we actually got audio tracks
                const audioTracks = stream.getAudioTracks();
                if (audioTracks.length === 0) {
                    stream.getTracks().forEach(track => track.stop());
                    throw { name: 'NotFoundError', message: 'No audio tracks in stream' };
                }

                // Check track state
                const track = audioTracks[0];
                console.log('[Mic Test] Audio track:', {
                    label: track.label,
                    enabled: track.enabled,
                    muted: track.muted,
                    readyState: track.readyState
                });

                if (track.muted || track.readyState !== 'live') {
                    stream.getTracks().forEach(track => track.stop());
                    throw { name: 'NotReadableError', message: 'Audio track is muted or not live' };
                }

                // Success! Stop the stream
                stream.getTracks().forEach(track => track.stop());

                microphoneState.status = 'working';
                microphoneState.lastError = null;
                localStorage.setItem('fvp_mic_granted', 'true');
                localStorage.setItem('fvp_mic_tested', new Date().toISOString());

                if (showUI) {
                    updateMicrophoneStatusUI('working');
                }

                console.log('[Mic Test] SUCCESS - Microphone is working');
                return { success: true, status: 'working' };

            } catch (err) {
                console.error('[Mic Test] FAILED:', err.name, err.message);

                const errorInfo = getMicrophoneErrorInfo(err.name);
                microphoneState.status = errorInfo.severity;
                microphoneState.lastError = {
                    name: err.name,
                    message: err.message,
                    info: errorInfo,
                    timestamp: new Date().toISOString()
                };

                // Clear stale permission data if denied
                if (errorInfo.severity === 'denied') {
                    localStorage.removeItem('fvp_mic_granted');
                    localStorage.removeItem('fvp_mic_tested');
                }

                if (showUI) {
                    updateMicrophoneStatusUI(errorInfo.severity, errorInfo);
                }

                return {
                    success: false,
                    status: errorInfo.severity,
                    error: errorInfo
                };
            }
        }

        // Check if Speech Recognition is available
        function checkSpeechRecognitionSupport() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                return {
                    supported: false,
                    error: {
                        title: 'Speech Recognition Unavailable',
                        message: 'This browser doesn\'t support speech recognition.',
                        recovery: 'Try Chrome, Safari, or Edge browser.',
                        icon: 'fa-comment-slash',
                        severity: 'unavailable'
                    }
                };
            }
            return { supported: true };
        }

        // Update microphone status in the UI
        function updateMicrophoneStatusUI(status, errorInfo = null) {
            const voiceBtns = document.querySelectorAll('.voice-btn');

            voiceBtns.forEach(btn => {
                // Remove any existing status classes
                btn.classList.remove('mic-testing', 'mic-working', 'mic-error', 'mic-denied');

                switch(status) {
                    case 'testing':
                        btn.classList.add('mic-testing');
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        btn.title = 'Testing microphone...';
                        break;
                    case 'working':
                        btn.classList.add('mic-working');
                        btn.innerHTML = '<i class="fas fa-microphone"></i>';
                        btn.title = 'Microphone ready';
                        break;
                    case 'denied':
                        btn.classList.add('mic-denied');
                        btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                        btn.title = errorInfo?.message || 'Microphone blocked';
                        break;
                    case 'unavailable':
                        btn.classList.add('mic-error');
                        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                        btn.title = errorInfo?.message || 'Microphone unavailable';
                        break;
                    case 'error':
                        btn.classList.add('mic-error');
                        btn.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                        btn.title = errorInfo?.message || 'Microphone error';
                        break;
                    default:
                        btn.innerHTML = '<i class="fas fa-microphone"></i>';
                        btn.title = 'Tap to record';
                }
            });
        }

        // ============ PERMISSIONS ============
        async function checkPermissions() {
            const micStatus = await checkMicrophonePermission();
            const locStatus = await checkLocationPermission();

            updatePermissionUI('mic', micStatus);
            updatePermissionUI('loc', locStatus);

            // Show modal if either permission is not granted and not previously dismissed
            const dismissed = localStorage.getItem('permissions_dismissed');
            if (!dismissed && (micStatus !== 'granted' || locStatus !== 'granted')) {
                document.getElementById('permissionsModal').classList.remove('hidden');
            }

            return { mic: micStatus, loc: locStatus };
        }

        async function checkMicrophonePermission() {
            // If we have a cached test result from this session, use it
            const lastTested = localStorage.getItem('fvp_mic_tested');
            const wasGranted = localStorage.getItem('fvp_mic_granted') === 'true';

            // If tested recently (within 5 minutes), trust the cached result
            if (lastTested && wasGranted) {
                const testedAt = new Date(lastTested);
                const now = new Date();
                const fiveMinutes = 5 * 60 * 1000;
                if (now - testedAt < fiveMinutes) {
                    microphoneState.status = 'working';
                    return 'granted';
                }
            }

            try {
                // Try permissions API first (not always supported)
                if (navigator.permissions) {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    if (result.state === 'denied') {
                        microphoneState.status = 'denied';
                        return 'denied';
                    }
                    if (result.state === 'granted') {
                        // Even if API says granted, we should verify it works
                        // But don't block on this - return granted and test async
                        return 'granted';
                    }
                }
            } catch (e) {
                // Permissions API not supported for microphone
            }
            return 'prompt'; // Default to prompt if we can't check
        }

        async function checkLocationPermission() {
            try {
                if (navigator.permissions) {
                    const result = await navigator.permissions.query({ name: 'geolocation' });
                    return result.state;
                }
            } catch (e) {}
            return 'prompt';
        }

        async function requestMicrophonePermission() {
            const btn = document.getElementById('micPermissionBtn');
            const status = document.getElementById('micPermissionStatus');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            status.textContent = 'Testing...';

            // Use the comprehensive microphone test
            const result = await testMicrophone(true);

            if (result.success) {
                updatePermissionUI('mic', 'granted');
                showToast('Microphone enabled and working!', 'success');
            } else {
                const errorInfo = result.error;

                if (errorInfo.severity === 'denied') {
                    updatePermissionUI('mic', 'denied');
                    status.textContent = errorInfo.message;
                    showPermissionAlert('microphone');
                } else if (errorInfo.severity === 'unavailable') {
                    status.textContent = errorInfo.message;
                    btn.textContent = 'N/A';
                    btn.disabled = true;
                    btn.className = 'px-4 py-2 bg-gray-600 text-white text-xs font-bold rounded-lg cursor-not-allowed';
                } else {
                    status.textContent = errorInfo.message;
                    btn.innerHTML = '<i class="fas fa-redo mr-1"></i>Retry';
                    btn.disabled = false;
                }
            }
        }

        async function requestLocationPermission() {
            const btn = document.getElementById('locPermissionBtn');
            const status = document.getElementById('locPermissionStatus');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => resolve(pos),
                        (err) => reject(err),
                        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                    );
                });

                // Persist permission state in localStorage
                localStorage.setItem('fvp_loc_granted', 'true');
                localStorage.setItem('fvp_loc_date', new Date().toISOString());

                updatePermissionUI('loc', 'granted');
                showToast('Location enabled!');

                // Also fetch weather now that we have permission
                fetchWeather();
            } catch (err) {
                console.error('Location permission error:', err);
                if (err.code === 1) { // PERMISSION_DENIED
                    updatePermissionUI('loc', 'denied');
                    showPermissionAlert('location');
                } else {
                    status.textContent = err.message || 'Error';
                    btn.textContent = 'Retry';
                    btn.disabled = false;
                }
            }
        }

        function updatePermissionUI(type, state) {
            const btn = document.getElementById(`${type}PermissionBtn`);
            const status = document.getElementById(`${type}PermissionStatus`);
            const row = document.getElementById(`${type}PermissionRow`);

            if (state === 'granted') {
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.className = 'px-4 py-2 bg-emerald-500 text-white text-xs font-bold rounded-lg cursor-default';
                btn.disabled = true;
                // Show "Verified" for microphone since we actually tested it
                status.textContent = type === 'mic' ? 'Verified Working' : 'Enabled';
                status.className = 'text-xs text-emerald-400';
                row.className = 'bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4';
            } else if (state === 'denied') {
                btn.textContent = 'Denied';
                btn.className = 'px-4 py-2 bg-red-500/50 text-white text-xs font-bold rounded-lg';
                btn.disabled = true;
                // Show more specific error if available
                if (type === 'mic' && microphoneState.lastError?.info?.message) {
                    status.textContent = microphoneState.lastError.info.message;
                } else {
                    status.textContent = 'Blocked - check settings';
                }
                status.className = 'text-xs text-red-400';
                row.className = 'bg-red-500/10 border border-red-500/30 rounded-xl p-4';
            } else {
                // Reset to default/prompt state
                btn.textContent = 'Enable';
                btn.disabled = false;
                if (type === 'mic') {
                    btn.className = 'px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold rounded-lg transition-colors';
                    status.textContent = 'For voice notes';
                } else {
                    btn.className = 'px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded-lg transition-colors';
                    status.textContent = 'For weather & GPS';
                }
                status.className = 'text-xs text-white/50';
                row.className = 'bg-white/5 rounded-xl p-4';
            }
        }

        function closePermissionsModal() {
            document.getElementById('permissionsModal').classList.add('hidden');
            localStorage.setItem('permissions_dismissed', 'true');
        }

        function showPermissionsModal() {
            // Reset dismissed state and show modal
            localStorage.removeItem('permissions_dismissed');
            checkPermissions();
            document.getElementById('permissionsModal').classList.remove('hidden');
        }

        // ============ STORAGE ============
        function getTodayKey() {
            return `fieldvoice_report_${new Date().toISOString().split('T')[0]}`;
        }

        function getReport() {
            const saved = localStorage.getItem(getTodayKey());
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Ensure required properties exist for legacy reports
                    if (!parsed.meta) parsed.meta = {};
                    if (!parsed.meta.naMarked) parsed.meta.naMarked = {};
                    if (!parsed.safety) parsed.safety = { hasIncidents: false, noIncidents: false, notes: [] };
                    if (parsed.safety.noIncidents === undefined) parsed.safety.noIncidents = false;
                    return parsed;
                } catch (e) {}
            }
            return createFreshReport();
        }

        function createFreshReport() {
            return {
                meta: {
                    createdAt: new Date().toISOString(),
                    interviewCompleted: false,
                    reportType: 'quick',
                    version: 2,
                    naMarked: {}
                },
                overview: {
                    projectName: "North-South Connector Road Phase 2",
                    date: new Date().toLocaleDateString(),
                    startTime: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                    weather: {
                        highTemp: "--",
                        lowTemp: "--",
                        precipitation: "0.00\"",
                        generalCondition: "Syncing...",
                        jobSiteCondition: "",
                        adverseConditions: "N/A"
                    }
                },
                contractors: [],
                activities: [],
                operations: [],
                equipment: [],
                generalIssues: [],
                qaqcNotes: [],
                safety: { hasIncidents: false, noIncidents: false, notes: [] },
                visitorsRemarks: [],
                photos: []
            };
        }

        function saveReport() {
            localStorage.setItem(getTodayKey(), JSON.stringify(report));
            localStorage.setItem('fieldvoice_report', JSON.stringify(report));
            updateAllPreviews();
            updateProgress();
        }

        // ============ WEATHER ============
        async function fetchWeather() {
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
                });

                const { latitude, longitude } = position.coords;
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto&temperature_unit=fahrenheit&precipitation_unit=inch`
                );
                const data = await response.json();

                const weatherCodes = {
                    0: 'Clear', 1: 'Mostly Clear', 2: 'Partly Cloudy', 3: 'Overcast',
                    45: 'Fog', 48: 'Fog', 51: 'Light Drizzle', 53: 'Drizzle', 55: 'Heavy Drizzle',
                    61: 'Light Rain', 63: 'Rain', 65: 'Heavy Rain', 80: 'Showers', 95: 'Thunderstorm'
                };

                const precip = data.daily.precipitation_sum[0];
                report.overview.weather = {
                    highTemp: `${Math.round(data.daily.temperature_2m_max[0])}°F`,
                    lowTemp: `${Math.round(data.daily.temperature_2m_min[0])}°F`,
                    precipitation: `${precip.toFixed(2)}"`,
                    generalCondition: weatherCodes[data.current_weather.weathercode] || 'Cloudy',
                    jobSiteCondition: report.overview.weather.jobSiteCondition || (precip > 0.1 ? 'Wet' : 'Dry'),
                    adverseConditions: precip > 0.25 ? 'Rain impact possible' : 'N/A'
                };

                saveReport();
                updateWeatherDisplay();
            } catch (error) {
                console.error('Weather fetch failed:', error);
                // Check if it's a permission error
                if (error.code === 1) { // GeolocationPositionError.PERMISSION_DENIED
                    showPermissionAlert('location');
                }
            }
        }

        function updateWeatherDisplay() {
            const w = report.overview.weather;
            document.getElementById('weather-condition').textContent = w.generalCondition;
            document.getElementById('weather-temp').textContent = `${w.highTemp} / ${w.lowTemp}`;
            document.getElementById('weather-precip').textContent = w.precipitation;
            document.getElementById('site-conditions-input').value = w.jobSiteCondition || '';
        }

        // ============ SECTION TOGGLE ============
        function toggleSection(sectionId) {
            const cards = document.querySelectorAll('.section-card');
            cards.forEach(card => {
                if (card.dataset.section === sectionId) {
                    card.classList.toggle('expanded');
                    const icon = card.querySelector('[id$="-status"] i');
                    if (card.classList.contains('expanded')) {
                        icon.className = 'fas fa-chevron-up text-indigo-400 text-xs';
                    } else {
                        icon.className = 'fas fa-chevron-down text-white/30 text-xs';
                    }
                } else {
                    card.classList.remove('expanded');
                    const icon = card.querySelector('[id$="-status"] i');
                    icon.className = 'fas fa-chevron-down text-white/30 text-xs';
                }
            });
        }

        // ============ VOICE RECORDING ============
        async function recordVoice(section) {
            // First, check if speech recognition is supported
            const speechCheck = checkSpeechRecognitionSupport();
            if (!speechCheck.supported) {
                showMicrophoneError(speechCheck.error);
                return;
            }

            // Check/test microphone before starting
            if (microphoneState.status === 'denied' || microphoneState.status === 'unavailable') {
                // Show the last error if we have one
                if (microphoneState.lastError) {
                    showMicrophoneError(microphoneState.lastError.info);
                } else {
                    showPermissionAlert('microphone');
                }
                return;
            }

            // If we haven't tested the mic yet or it's been a while, test it now
            if (microphoneState.status === 'unknown' || microphoneState.status === 'error') {
                const testResult = await testMicrophone(true);
                if (!testResult.success) {
                    showMicrophoneError(testResult.error);
                    return;
                }
            }

            // All checks passed, show the modal
            activeVoiceSection = section;
            currentTranscript = '';

            const modal = document.getElementById('voiceModal');
            const transcriptEl = document.getElementById('liveTranscript');
            const titleEl = document.getElementById('voiceModalTitle');
            const stopBtn = document.getElementById('stopVoiceBtn');

            // Reset modal state
            transcriptEl.textContent = 'Starting...';
            transcriptEl.className = 'text-sm text-white/80 italic';
            stopBtn.disabled = false;

            const sectionNames = {
                weather: 'Site Conditions',
                activities: 'Work Summary',
                issues: 'Issues',
                inspections: 'Inspections',
                safety: 'Safety',
                visitors: 'Visitors'
            };
            titleEl.textContent = `Recording: ${sectionNames[section]}`;

            modal.classList.remove('hidden');
            startRecording();
        }

        function startRecording() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showMicrophoneError({
                    title: 'Not Supported',
                    message: 'Speech recognition not available.',
                    recovery: 'Try Chrome or Safari browser.',
                    icon: 'fa-comment-slash',
                    severity: 'unavailable'
                });
                cancelVoice();
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            const transcriptEl = document.getElementById('liveTranscript');
            let noSpeechCount = 0;
            let hasReceivedSpeech = false;

            recognition.onstart = () => {
                isRecording = true;
                transcriptEl.textContent = 'Listening...';
                transcriptEl.className = 'text-sm text-white/80 italic';
                console.log('[Speech] Recognition started');
            };

            recognition.onaudiostart = () => {
                console.log('[Speech] Audio capture started');
                transcriptEl.textContent = 'Listening... speak now';
            };

            recognition.onsoundstart = () => {
                console.log('[Speech] Sound detected');
            };

            recognition.onspeechstart = () => {
                console.log('[Speech] Speech detected');
                hasReceivedSpeech = true;
            };

            recognition.onresult = (event) => {
                let transcript = '';
                let isFinal = false;
                for (let i = 0; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        isFinal = true;
                    }
                }
                currentTranscript = transcript;
                transcriptEl.textContent = transcript || 'Listening...';
                transcriptEl.className = 'text-sm text-white';
                hasReceivedSpeech = true;
            };

            recognition.onend = () => {
                console.log('[Speech] Recognition ended, isRecording:', isRecording);

                // If we're still supposed to be recording, restart
                if (isRecording && !hasReceivedSpeech && noSpeechCount < 3) {
                    noSpeechCount++;
                    console.log('[Speech] Restarting due to no speech, attempt:', noSpeechCount);
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('[Speech] Restart failed:', e);
                    }
                    return;
                }

                isRecording = false;
            };

            recognition.onerror = (event) => {
                console.error('[Speech] Recognition error:', event.error, event.message);

                const errorInfo = getMicrophoneErrorInfo(event.error);

                // Update microphone state
                microphoneState.lastError = {
                    name: event.error,
                    message: event.message,
                    info: errorInfo,
                    timestamp: new Date().toISOString()
                };

                // Handle based on severity
                if (errorInfo.severity === 'denied') {
                    isRecording = false;
                    microphoneState.status = 'denied';
                    localStorage.removeItem('fvp_mic_granted');
                    localStorage.removeItem('fvp_mic_tested');
                    cancelVoice();
                    showMicrophoneError(errorInfo);
                } else if (errorInfo.severity === 'info') {
                    // Informational errors (no-speech, aborted) - show subtle feedback
                    if (event.error === 'no-speech') {
                        noSpeechCount++;
                        if (noSpeechCount >= 3) {
                            transcriptEl.textContent = 'No speech detected. Tap stop or try speaking louder.';
                            transcriptEl.className = 'text-sm text-amber-400 italic';
                        }
                    }
                    // Don't cancel - let user continue or stop manually
                } else if (errorInfo.severity === 'error') {
                    // Temporary errors - show toast and let user retry
                    isRecording = false;
                    showToast(errorInfo.message + ' ' + errorInfo.recovery, 'warning');
                    transcriptEl.textContent = errorInfo.message;
                    transcriptEl.className = 'text-sm text-red-400';
                } else {
                    // Unknown/unavailable - show full error
                    isRecording = false;
                    cancelVoice();
                    showMicrophoneError(errorInfo);
                }
            };

            try {
                recognition.start();
            } catch (err) {
                console.error('[Speech] Failed to start:', err);
                isRecording = false;
                showMicrophoneError({
                    title: 'Start Failed',
                    message: 'Could not start speech recognition.',
                    recovery: 'Close and reopen the app, then try again.',
                    icon: 'fa-exclamation-triangle',
                    severity: 'error'
                });
                cancelVoice();
            }
        }

        // Show detailed microphone error modal
        function showMicrophoneError(errorInfo) {
            const existing = document.querySelector('.mic-error-modal');
            if (existing) existing.remove();

            const severityColors = {
                denied: { bg: 'bg-red-500/20', border: 'border-red-500/50', icon: 'text-red-400', text: 'text-red-300' },
                unavailable: { bg: 'bg-amber-500/20', border: 'border-amber-500/50', icon: 'text-amber-400', text: 'text-amber-300' },
                error: { bg: 'bg-orange-500/20', border: 'border-orange-500/50', icon: 'text-orange-400', text: 'text-orange-300' },
                info: { bg: 'bg-blue-500/20', border: 'border-blue-500/50', icon: 'text-blue-400', text: 'text-blue-300' }
            };
            const colors = severityColors[errorInfo.severity] || severityColors.error;

            const modal = document.createElement('div');
            modal.className = 'mic-error-modal fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-3xl p-6 max-w-sm w-full border ${colors.border} shadow-2xl">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-14 h-14 rounded-2xl ${colors.bg} flex items-center justify-center flex-shrink-0">
                            <i class="fas ${errorInfo.icon} ${colors.icon} text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-lg">${errorInfo.title}</h3>
                            <p class="text-sm ${colors.text}">${errorInfo.message}</p>
                        </div>
                    </div>

                    <div class="bg-slate-900/50 rounded-2xl p-4 mb-5">
                        <p class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-2">
                            <i class="fas fa-lightbulb mr-2"></i>How to fix
                        </p>
                        <p class="text-sm text-white/80">${errorInfo.recovery}</p>
                        ${errorInfo.isIOSSpecific ? `
                            <div class="mt-3 pt-3 border-t border-white/10">
                                <p class="text-xs text-amber-300 flex items-center gap-2 mb-2">
                                    <i class="fab fa-apple"></i> iPhone Settings Steps:
                                </p>
                                <ol class="text-xs text-white/60 space-y-2 list-decimal list-inside">
                                    <li>Open <strong class="text-amber-300">Settings</strong> app</li>
                                    <li>Go to <strong class="text-amber-300">Siri & Search</strong></li>
                                    <li>Enable <strong class="text-emerald-400">"Listen for Hey Siri"</strong> or <strong class="text-emerald-400">"Press Side Button for Siri"</strong></li>
                                    <li><strong>OR</strong> go to <strong class="text-amber-300">Settings → General → Keyboard</strong></li>
                                    <li>Enable <strong class="text-emerald-400">"Enable Dictation"</strong></li>
                                    <li>Return here and try again</li>
                                </ol>
                            </div>
                        ` : ''}
                        ${errorInfo.severity === 'denied' && isIOSSafari && !errorInfo.isIOSSpecific ? `
                            <div class="mt-3 pt-3 border-t border-white/10">
                                <p class="text-xs text-amber-300 flex items-center gap-2 mb-2">
                                    <i class="fab fa-safari"></i> iOS Safari Steps:
                                </p>
                                <ol class="text-xs text-white/60 space-y-1 list-decimal list-inside">
                                    <li>Tap the <strong class="text-amber-300">"aA"</strong> in address bar</li>
                                    <li>Select <strong class="text-amber-300">"Website Settings"</strong></li>
                                    <li>Set <strong class="text-amber-300">Microphone</strong> to Allow</li>
                                    <li>Return here and try again</li>
                                </ol>
                            </div>
                        ` : ''}
                    </div>

                    <div class="flex gap-3">
                        <button onclick="this.closest('.mic-error-modal').remove()" class="flex-1 p-4 bg-white/10 hover:bg-white/20 text-white font-bold rounded-xl transition-colors">
                            Close
                        </button>
                        ${errorInfo.severity === 'denied' ? `
                            <button onclick="retryMicrophone()" class="flex-1 p-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-rotate"></i>Retry
                            </button>
                        ` : `
                            <button onclick="retryMicrophone()" class="flex-1 p-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-redo"></i>Try Again
                            </button>
                        `}
                    </div>

                    ${microphoneState.lastError ? `
                        <details class="mt-4">
                            <summary class="text-xs text-white/30 cursor-pointer hover:text-white/50">Technical Details</summary>
                            <pre class="mt-2 text-[10px] text-white/40 bg-black/30 rounded-lg p-2 overflow-x-auto">${JSON.stringify({
                                error: microphoneState.lastError.name,
                                message: microphoneState.lastError.message,
                                time: microphoneState.lastError.timestamp,
                                browser: navigator.userAgent.substring(0, 60)
                            }, null, 2)}</pre>
                        </details>
                    ` : ''}
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Retry microphone after error
        async function retryMicrophone() {
            const modal = document.querySelector('.mic-error-modal');
            if (modal) modal.remove();

            // Reset state
            microphoneState.status = 'unknown';
            microphoneState.lastError = null;

            // Show testing toast
            showToast('Testing microphone...', 'info');

            // Test the microphone
            const result = await testMicrophone(true);

            if (result.success) {
                showToast('Microphone is working!', 'success');
            } else {
                // testMicrophone already showed the error UI
            }
        }

        function stopVoice() {
            if (recognition) {
                recognition.stop();
                recognition = null;
            }
            isRecording = false;

            const transcript = currentTranscript.trim();
            if (transcript) {
                applyVoiceToSection(activeVoiceSection, transcript);
            }

            document.getElementById('voiceModal').classList.add('hidden');
            currentTranscript = '';
            activeVoiceSection = null;
        }

        function cancelVoice() {
            if (recognition) {
                recognition.stop();
                recognition = null;
            }
            isRecording = false;
            currentTranscript = '';
            activeVoiceSection = null;
            document.getElementById('voiceModal').classList.add('hidden');
        }

        function applyVoiceToSection(section, transcript) {
            switch (section) {
                case 'weather':
                    report.overview.weather.jobSiteCondition = transcript;
                    document.getElementById('site-conditions-input').value = transcript;
                    break;
                case 'activities':
                    report.activities.push({
                        contractor: 'General',
                        trade: 'General',
                        narrative: transcript
                    });
                    break;
                case 'issues':
                    if (!transcript.toLowerCase().includes('none') && !transcript.toLowerCase().includes('no issues')) {
                        report.generalIssues.push(transcript);
                    }
                    break;
                case 'inspections':
                    if (!transcript.toLowerCase().includes('none') && !transcript.toLowerCase().includes('no inspection')) {
                        report.qaqcNotes.push(transcript);
                    }
                    break;
                case 'safety':
                    report.safety.notes.push(transcript);
                    if (transcript.toLowerCase().includes('incident') || transcript.toLowerCase().includes('injury')) {
                        report.safety.hasIncidents = true;
                    }
                    break;
                case 'visitors':
                    if (!transcript.toLowerCase().includes('none') && !transcript.toLowerCase().includes('no visitor')) {
                        report.visitorsRemarks.push(transcript);
                    }
                    break;
            }

            saveReport();
            renderSection(section);
            showToast('Added successfully');
        }

        // ============ MANUAL ADD FUNCTIONS ============
        function addActivity() {
            const input = document.getElementById('activity-input');
            const text = input.value.trim();
            if (text) {
                report.activities.push({
                    contractor: 'General',
                    trade: 'General',
                    narrative: text
                });
                saveReport();
                renderSection('activities');
                input.value = '';
            }
        }

        function removeActivity(index) {
            report.activities.splice(index, 1);
            saveReport();
            renderSection('activities');
        }

        function addIssue() {
            const input = document.getElementById('issue-input');
            const text = input.value.trim();
            if (text) {
                report.generalIssues.push(text);
                saveReport();
                renderSection('issues');
                input.value = '';
            }
        }

        function removeIssue(index) {
            report.generalIssues.splice(index, 1);
            saveReport();
            renderSection('issues');
        }

        function addInspection() {
            const input = document.getElementById('inspection-input');
            const text = input.value.trim();
            if (text) {
                report.qaqcNotes.push(text);
                saveReport();
                renderSection('inspections');
                input.value = '';
            }
        }

        function removeInspection(index) {
            report.qaqcNotes.splice(index, 1);
            saveReport();
            renderSection('inspections');
        }

        function addSafetyNote() {
            const input = document.getElementById('safety-input');
            const text = input.value.trim();
            if (text) {
                report.safety.notes.push(text);
                saveReport();
                renderSection('safety');
                input.value = '';
            }
        }

        function removeSafetyNote(index) {
            report.safety.notes.splice(index, 1);
            saveReport();
            renderSection('safety');
        }

        function addVisitor() {
            const input = document.getElementById('visitor-input');
            const text = input.value.trim();
            if (text) {
                report.visitorsRemarks.push(text);
                saveReport();
                renderSection('visitors');
                input.value = '';
            }
        }

        function removeVisitor(index) {
            report.visitorsRemarks.splice(index, 1);
            saveReport();
            renderSection('visitors');
        }

        // ============ PHOTOS ============
        async function handlePhotoInput(e) {
            const files = e.target.files;
            if (!files) return;

            for (const file of files) {
                let gps = null;
                let gpsError = null;

                try {
                    if (!navigator.geolocation) {
                        throw { code: -1, message: 'Geolocation not supported' };
                    }

                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            resolve,
                            reject,
                            { timeout: 5000, enableHighAccuracy: true, maximumAge: 60000 }
                        );
                    });

                    gps = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        accuracy: pos.coords.accuracy
                    };

                    // Update localStorage since location worked
                    localStorage.setItem('fvp_loc_granted', 'true');

                    console.log('Photo GPS captured:', gps);
                } catch (err) {
                    gpsError = err;
                    console.warn('Photo GPS failed:', {
                        code: err.code,
                        message: err.message
                    });

                    // Handle permission denied - clear stale localStorage
                    if (err.code === 1) {
                        localStorage.removeItem('fvp_loc_granted');
                        localStorage.removeItem('fvp_loc_date');
                    }
                }

                const reader = new FileReader();
                reader.onload = (ev) => {
                    report.photos.push({
                        id: `photo_${Date.now()}`,
                        url: ev.target.result,
                        caption: '',
                        timestamp: new Date().toISOString(),
                        date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                        gps: gps,
                        gpsError: gpsError ? { code: gpsError.code, message: gpsError.message } : null
                    });
                    saveReport();
                    renderSection('photos');

                    // Show feedback about GPS status
                    if (gps) {
                        showToast('Photo added with GPS', 'success');
                    } else if (gpsError?.code === 1) {
                        showToast('Photo added (GPS blocked - check settings)', 'warning');
                    } else if (gpsError?.code === 2) {
                        showToast('Photo added (GPS unavailable)', 'warning');
                    } else if (gpsError?.code === 3) {
                        showToast('Photo added (GPS timed out)', 'warning');
                    } else {
                        showToast('Photo added (no GPS)', 'info');
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function removePhoto(index) {
            report.photos.splice(index, 1);
            saveReport();
            renderSection('photos');
        }

        // ============ RENDER SECTIONS ============
        function renderSection(section) {
            switch (section) {
                case 'activities':
                    const activitiesList = document.getElementById('activities-list');
                    activitiesList.innerHTML = report.activities.map((a, i) => `
                        <div class="bg-white/5 rounded-xl p-3 flex items-start gap-3">
                            <div class="flex-1">
                                <p class="text-[10px] font-bold text-emerald-400 uppercase">${a.contractor}</p>
                                <p class="text-sm text-white/80 mt-1">${a.narrative}</p>
                            </div>
                            <button onclick="removeActivity(${i})" class="text-red-400/50 hover:text-red-400">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    `).join('') || '';
                    break;

                case 'issues':
                    const issuesList = document.getElementById('issues-list');
                    issuesList.innerHTML = report.generalIssues.map((issue, i) => `
                        <div class="bg-white/5 rounded-xl p-3 flex items-start gap-3">
                            <i class="fas fa-exclamation-circle text-red-400 mt-0.5"></i>
                            <p class="flex-1 text-sm text-white/80">${issue}</p>
                            <button onclick="removeIssue(${i})" class="text-red-400/50 hover:text-red-400">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    `).join('') || '';
                    break;

                case 'inspections':
                    const inspectionsList = document.getElementById('inspections-list');
                    inspectionsList.innerHTML = report.qaqcNotes.map((note, i) => `
                        <div class="bg-white/5 rounded-xl p-3 flex items-start gap-3">
                            <i class="fas fa-check-circle text-purple-400 mt-0.5"></i>
                            <p class="flex-1 text-sm text-white/80">${note}</p>
                            <button onclick="removeInspection(${i})" class="text-red-400/50 hover:text-red-400">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    `).join('') || '';
                    break;

                case 'safety':
                    const safetyList = document.getElementById('safety-list');
                    safetyList.innerHTML = report.safety.notes.map((note, i) => `
                        <div class="bg-white/5 rounded-xl p-3 flex items-start gap-3">
                            <i class="fas fa-shield-alt text-green-400 mt-0.5"></i>
                            <p class="flex-1 text-sm text-white/80">${note}</p>
                            <button onclick="removeSafetyNote(${i})" class="text-red-400/50 hover:text-red-400">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    `).join('') || '';
                    document.getElementById('has-incidents').checked = report.safety.hasIncidents;
                    break;

                case 'visitors':
                    const visitorsList = document.getElementById('visitors-list');
                    visitorsList.innerHTML = report.visitorsRemarks.map((v, i) => `
                        <div class="bg-white/5 rounded-xl p-3 flex items-start gap-3">
                            <i class="fas fa-user text-indigo-400 mt-0.5"></i>
                            <p class="flex-1 text-sm text-white/80">${v}</p>
                            <button onclick="removeVisitor(${i})" class="text-red-400/50 hover:text-red-400">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    `).join('') || '';
                    break;

                case 'photos':
                    const photosGrid = document.getElementById('photos-grid');
                    photosGrid.innerHTML = report.photos.map((p, i) => `
                        <div class="relative bg-white/5 rounded-xl overflow-hidden">
                            <img src="${p.url}" class="w-full aspect-square object-cover">
                            <button onclick="removePhoto(${i})" class="absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full text-xs flex items-center justify-center">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2">
                                <p class="text-[10px] text-white/70">${p.time}</p>
                            </div>
                        </div>
                    `).join('') || '';
                    break;
            }
        }

        function renderAllSections() {
            ['activities', 'issues', 'inspections', 'safety', 'visitors', 'photos'].forEach(renderSection);
            updateWeatherDisplay();
        }

        // ============ PREVIEWS & PROGRESS ============
        function updateAllPreviews() {
            // Weather preview
            const w = report.overview.weather;
            document.getElementById('weather-preview').textContent =
                w.jobSiteCondition || `${w.generalCondition}, ${w.highTemp}`;

            // Activities preview
            document.getElementById('activities-preview').textContent =
                report.activities.length > 0 ? `${report.activities.length} activities logged` : 'Tap to add';

            // Issues preview
            const naMarked = report.meta.naMarked || {};
            document.getElementById('issues-preview').textContent =
                naMarked.issues ? 'N/A - No issues' :
                report.generalIssues.length > 0 ? `${report.generalIssues.length} issues` : 'None reported';

            // Inspections preview
            document.getElementById('inspections-preview').textContent =
                naMarked.inspections ? 'N/A - No inspections' :
                report.qaqcNotes.length > 0 ? `${report.qaqcNotes.length} inspections` : 'None reported';

            // Safety preview
            document.getElementById('safety-preview').textContent =
                report.safety.hasIncidents ? 'INCIDENT REPORTED' :
                report.safety.noIncidents ? 'No incidents (confirmed)' :
                report.safety.notes.length > 0 ? 'Notes added' : 'Tap to confirm';

            // Visitors preview
            document.getElementById('visitors-preview').textContent =
                naMarked.visitors ? 'N/A - No visitors' :
                report.visitorsRemarks.length > 0 ? `${report.visitorsRemarks.length} entries` : 'None reported';

            // Photos preview
            document.getElementById('photos-preview').textContent =
                report.photos.length > 0 ? `${report.photos.length} photos` : 'No photos';

            // Update status icons
            updateStatusIcons();
        }

        function updateStatusIcons() {
            const naMarked = report.meta.naMarked || {};
            const sections = {
                'weather': report.overview.weather.jobSiteCondition,
                'activities': report.activities.length > 0,
                'issues': report.generalIssues.length > 0 || naMarked.issues,
                'inspections': report.qaqcNotes.length > 0 || naMarked.inspections,
                'safety': report.safety.noIncidents || report.safety.hasIncidents || report.safety.notes.length > 0,
                'visitors': report.visitorsRemarks.length > 0 || naMarked.visitors,
                'photos': report.photos.length > 0
            };

            Object.entries(sections).forEach(([section, hasData]) => {
                const statusEl = document.getElementById(`${section}-status`);
                if (!statusEl) return;

                const card = document.querySelector(`[data-section="${section}"]`);
                const isExpanded = card?.classList.contains('expanded');

                if (hasData && !isExpanded) {
                    statusEl.innerHTML = '<i class="fas fa-check text-emerald-400 text-xs"></i>';
                    statusEl.className = 'w-6 h-6 rounded-full bg-emerald-500/20 flex items-center justify-center';
                } else if (!isExpanded) {
                    statusEl.innerHTML = '<i class="fas fa-chevron-down text-white/30 text-xs"></i>';
                    statusEl.className = 'w-6 h-6 rounded-full bg-white/10 flex items-center justify-center';
                }
            });
        }

        function updateProgress() {
            let filled = 0;
            let total = 3; // Required sections for quick report

            if (report.overview.weather.jobSiteCondition) filled++;
            if (report.activities.length > 0) filled++;
            if (report.safety.notes.length > 0 || report.safety.noIncidents || report.safety.hasIncidents) filled++;

            const percent = Math.round((filled / total) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${percent}%`;
        }

        // ============ UTILITIES ============
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast-msg');
            if (existing) existing.remove();

            const colors = {
                success: 'bg-emerald-600',
                warning: 'bg-amber-500',
                error: 'bg-red-500',
                info: 'bg-indigo-500'
            };

            const icons = {
                success: 'fa-check',
                warning: 'fa-exclamation-triangle',
                error: 'fa-times-circle',
                info: 'fa-info-circle'
            };

            const toast = document.createElement('div');
            toast.className = `toast-msg fixed bottom-24 left-1/2 -translate-x-1/2 ${colors[type] || colors.success} text-white px-6 py-3 rounded-full font-bold text-sm shadow-lg z-50 flex items-center gap-2`;
            toast.innerHTML = `<i class="fas ${icons[type] || icons.success}"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showPermissionAlert(type) {
            // Remove any existing permission alert
            const existing = document.querySelector('.permission-alert');
            if (existing) existing.remove();

            let title, message, steps, iosNote = '';

            if (type === 'microphone') {
                title = 'Enable Microphone';
                message = 'Voice recording requires microphone permission.';
                if (isIOSSafari) {
                    iosNote = '<p class="text-xs text-amber-300 mb-3 flex items-center gap-2"><i class="fab fa-safari"></i>iOS Safari detected</p>';
                    steps = [
                        'Tap the <strong class="text-amber-300">"aA"</strong> icon in the address bar <span class="text-white/50">(bottom left)</span>',
                        'Scroll down to <strong class="text-amber-300">"Website Settings"</strong> <span class="text-white/50">(for this site only)</span>',
                        'Set <strong class="text-amber-300">Microphone</strong> to <strong class="text-emerald-400">"Allow"</strong>',
                        'Return here and tap <strong class="text-emerald-400">"Check Again"</strong>'
                    ];
                } else if (isIOS) {
                    steps = [
                        'Open <strong>Settings</strong> app on your iPhone',
                        'Scroll down and tap <strong>Safari</strong>',
                        'Under "Settings for Websites", tap <strong>Microphone</strong>',
                        'Select <strong>Allow</strong>',
                        'Return here and tap <strong>Reload</strong>'
                    ];
                } else if (isAndroid) {
                    steps = [
                        'Tap the <strong>lock icon</strong> in address bar',
                        'Tap <strong>Permissions</strong>',
                        'Enable <strong>Microphone</strong>',
                        'Tap <strong>Reload</strong> below'
                    ];
                } else {
                    steps = [
                        'Click the <strong>lock icon</strong> in address bar',
                        'Set <strong>Microphone</strong> to Allow',
                        'Reload this page'
                    ];
                }
            } else if (type === 'location') {
                title = 'Enable Location';
                message = 'Weather and GPS tagging require location permission.';
                if (isIOSSafari) {
                    iosNote = '<p class="text-xs text-amber-300 mb-3 flex items-center gap-2"><i class="fab fa-safari"></i>iOS Safari detected</p>';
                    steps = [
                        'Tap the <strong class="text-amber-300">"aA"</strong> icon in the address bar <span class="text-white/50">(bottom left)</span>',
                        'Scroll down to <strong class="text-amber-300">"Website Settings"</strong> <span class="text-white/50">(for this site only)</span>',
                        'Set <strong class="text-amber-300">Location</strong> to <strong class="text-emerald-400">"Allow"</strong>',
                        'Return here and tap <strong class="text-emerald-400">"Check Again"</strong>'
                    ];
                } else if (isIOS) {
                    steps = [
                        'Open <strong>Settings</strong> app on your iPhone',
                        'Scroll down and tap <strong>Safari</strong>',
                        'Under "Settings for Websites", tap <strong>Location</strong>',
                        'Select <strong>Allow</strong>',
                        'Return here and tap <strong>Reload</strong>'
                    ];
                } else if (isAndroid) {
                    steps = [
                        'Tap the <strong>lock icon</strong> in address bar',
                        'Tap <strong>Permissions</strong>',
                        'Enable <strong>Location</strong>',
                        'Tap <strong>Reload</strong> below'
                    ];
                } else {
                    steps = [
                        'Click the <strong>lock icon</strong> in address bar',
                        'Set <strong>Location</strong> to Allow',
                        'Reload this page'
                    ];
                }
            }

            const stepsHtml = steps.map((step, i) => `
                <div class="flex items-start gap-3 ${i > 0 ? 'mt-3' : ''}">
                    <span class="flex-shrink-0 w-7 h-7 rounded-full bg-indigo-500 text-white text-xs font-bold flex items-center justify-center">${i + 1}</span>
                    <p class="text-sm text-white/90 leading-relaxed">${step}</p>
                </div>
            `).join('');

            const alert = document.createElement('div');
            alert.className = 'permission-alert fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4';
            alert.innerHTML = `
                <div class="bg-slate-800 rounded-3xl p-6 max-w-sm w-full border border-white/20 shadow-2xl">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-14 h-14 rounded-2xl bg-amber-500/20 flex items-center justify-center">
                            <i class="fas fa-${type === 'microphone' ? 'microphone-slash' : 'location-crosshairs'} text-amber-400 text-2xl"></i>
                        </div>
                        <div>
                            <p class="font-bold text-white text-lg">${title}</p>
                            <p class="text-xs text-amber-400">Permission was blocked</p>
                        </div>
                    </div>

                    <p class="text-sm text-white/70 mb-4">${message}</p>

                    <div class="bg-slate-900/70 rounded-2xl p-4 mb-5">
                        ${iosNote}
                        <p class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-3">
                            <i class="fas fa-list-ol mr-2"></i>To enable on iPhone:
                        </p>
                        ${stepsHtml}
                    </div>

                    <div class="flex gap-3">
                        <button onclick="this.closest('.permission-alert').remove()" class="flex-1 p-4 bg-white/10 hover:bg-white/20 text-white font-bold rounded-xl transition-colors">
                            Close
                        </button>
                        <button onclick="recheckAndReload()" class="flex-1 p-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl transition-colors flex items-center justify-center gap-2">
                            <i class="fas fa-rotate"></i>Check Again
                        </button>
                    </div>

                    <p class="text-center text-white/40 text-xs mt-4">
                        App works with limited features if permissions are denied
                    </p>
                </div>
            `;
            document.body.appendChild(alert);
        }

        async function recheckAndReload() {
            // Remove the alert
            const existing = document.querySelector('.permission-alert');
            if (existing) existing.remove();

            // Recheck permissions
            await checkPermissions();

            // If still denied, show toast
            const micGranted = localStorage.getItem('fvp_mic_granted') === 'true';
            const locGranted = localStorage.getItem('fvp_loc_granted') === 'true';

            if (!micGranted && !locGranted) {
                showToast('Permissions still blocked. Check Safari settings.');
            } else {
                showToast('Permissions updated!');
            }
        }

        function dismissWarningBanner() {
            document.getElementById('permissionsWarningBanner').classList.add('hidden');
        }

        function checkAndShowWarningBanner() {
            const micGranted = localStorage.getItem('fvp_mic_granted') === 'true';
            const locGranted = localStorage.getItem('fvp_loc_granted') === 'true';

            if (isMobile && (!micGranted || !locGranted)) {
                document.getElementById('permissionsWarningBanner').classList.remove('hidden');
            }
        }

        // ============ N/A MARKING ============
        function markNA(section) {
            if (!report.meta.naMarked) report.meta.naMarked = {};
            report.meta.naMarked[section] = true;

            const btn = document.getElementById(`${section}-na-btn`);
            if (btn) {
                btn.innerHTML = '<i class="fas fa-check mr-2"></i>Marked as N/A';
                btn.className = 'w-full p-3 bg-emerald-500/20 border border-emerald-500/30 rounded-xl text-emerald-400 text-sm font-medium cursor-default';
                btn.onclick = () => clearNA(section);
            }

            saveReport();
            updateAllPreviews();
            showToast('Marked as N/A');
        }

        function clearNA(section) {
            if (report.meta.naMarked) {
                delete report.meta.naMarked[section];
            }

            const btn = document.getElementById(`${section}-na-btn`);
            if (btn) {
                const labels = {
                    issues: 'No Issues - Mark as N/A',
                    inspections: 'No Inspections - Mark as N/A',
                    visitors: 'No Visitors - Mark as N/A'
                };
                btn.innerHTML = `<i class="fas fa-ban mr-2"></i>${labels[section] || 'Mark as N/A'}`;
                btn.className = 'w-full p-3 bg-white/5 border border-white/20 rounded-xl text-white/60 hover:bg-white/10 hover:text-white transition-colors text-sm font-medium';
                btn.onclick = () => markNA(section);
            }

            saveReport();
            updateAllPreviews();
            showToast('N/A cleared');
        }

        function updateNAButtons() {
            const naMarked = report.meta.naMarked || {};
            Object.keys(naMarked).forEach(section => {
                if (naMarked[section]) {
                    const btn = document.getElementById(`${section}-na-btn`);
                    if (btn) {
                        btn.innerHTML = '<i class="fas fa-check mr-2"></i>Marked as N/A';
                        btn.className = 'w-full p-3 bg-emerald-500/20 border border-emerald-500/30 rounded-xl text-emerald-400 text-sm font-medium cursor-default';
                        btn.onclick = () => clearNA(section);
                    }
                }
            });
        }

        function finishReport() {
            report.overview.endTime = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            report.meta.interviewCompleted = true;
            report.meta.reportType = 'quick';

            // Calculate shift duration
            if (report.overview.startTime) {
                const start = new Date(`2000/01/01 ${report.overview.startTime}`);
                const end = new Date(`2000/01/01 ${report.overview.endTime}`);
                const diffMs = end - start;
                const hours = Math.floor(diffMs / (1000 * 60 * 60));
                const mins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                report.overview.shiftDuration = `${hours}.${String(mins).padStart(2, '0')} hours`;
            }

            // Default safety if empty
            if (report.safety.notes.length === 0 && !report.safety.noIncidents) {
                report.safety.notes.push('No safety incidents reported.');
            }

            saveReport();
            // Go to review page instead of report page
            window.location.href = 'review.html';
        }

        // ============ EVENT LISTENERS ============
        document.getElementById('site-conditions-input').addEventListener('change', (e) => {
            report.overview.weather.jobSiteCondition = e.target.value;
            saveReport();
        });

        document.getElementById('no-incidents').addEventListener('change', (e) => {
            if (e.target.checked) {
                report.safety.hasIncidents = false;
                report.safety.noIncidents = true;
                document.getElementById('has-incidents').checked = false;
            } else {
                report.safety.noIncidents = false;
            }
            saveReport();
            updateAllPreviews();
        });

        document.getElementById('has-incidents').addEventListener('change', (e) => {
            report.safety.hasIncidents = e.target.checked;
            if (e.target.checked) {
                report.safety.noIncidents = false;
                document.getElementById('no-incidents').checked = false;
            }
            saveReport();
            updateAllPreviews();
        });

        document.getElementById('photoInput').addEventListener('change', handlePhotoInput);

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', async () => {
            // Set date
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });

            // Load report
            report = getReport();

            // Mark as quick report type
            report.meta.reportType = 'quick';
            saveReport();

            // Check and show warning banner if permissions are missing
            checkAndShowWarningBanner();

            // Check permissions and show modal if needed (on mobile)
            // Only show modal if user hasn't completed onboarding yet
            const onboarded = localStorage.getItem('fvp_onboarded') === 'true';
            if (isMobile && !onboarded) {
                await checkPermissions();
            }

            // Test microphone to show accurate status
            // Only do a quick check - don't show UI for this background test
            const micGranted = localStorage.getItem('fvp_mic_granted') === 'true';
            const lastTested = localStorage.getItem('fvp_mic_tested');
            const needsFreshTest = !lastTested || (new Date() - new Date(lastTested)) > 5 * 60 * 1000;

            if (micGranted && needsFreshTest) {
                // Silently verify mic still works (no UI)
                console.log('[Init] Verifying microphone permission...');
                const result = await testMicrophone(false);
                if (!result.success) {
                    console.warn('[Init] Microphone verification failed:', result.error);
                    // Update the UI to show the error state
                    updateMicrophoneStatusUI(result.status, result.error);
                } else {
                    console.log('[Init] Microphone verified working');
                    updateMicrophoneStatusUI('working');
                }
            } else if (micGranted) {
                // Trust the cached result
                microphoneState.status = 'working';
                updateMicrophoneStatusUI('working');
            }

            // Fetch weather if needed (will silently fail if location not granted)
            if (report.overview.weather.generalCondition === 'Syncing...' || report.overview.weather.generalCondition === '--') {
                await fetchWeather();
            }

            // Render all sections
            renderAllSections();
            updateAllPreviews();
            updateProgress();
            updateNAButtons();

            // Restore checkbox states
            document.getElementById('no-incidents').checked = report.safety.noIncidents || false;
            document.getElementById('has-incidents').checked = report.safety.hasIncidents || false;
        });
    </script>
</body>
</html>
