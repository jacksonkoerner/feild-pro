<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FieldVoice Daily Report Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }
        .animate-pulse-slow { animation: pulse-slow 2s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .gradient-bg {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e1b4b 100%);
        }
        @keyframes slide-down {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .slide-down { animation: slide-down 0.3s ease-out; }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Permissions Banner (shown when permissions are missing) -->
    <div id="permissionsBanner" class="hidden fixed top-0 left-0 right-0 z-50 slide-down">
        <div class="max-w-lg mx-auto">
            <div class="m-3 bg-amber-500/95 backdrop-blur-sm rounded-2xl p-4 shadow-lg border border-amber-400/30">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-shield-exclamation text-white text-lg"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-white text-sm">Permissions Needed</p>
                        <p id="permissionsBannerText" class="text-xs text-amber-100">Enable mic & location for full features</p>
                    </div>
                    <a href="permissions.html" class="px-4 py-2 bg-white text-amber-600 font-bold text-sm rounded-xl hover:bg-amber-50 transition-colors flex-shrink-0">
                        Enable
                    </a>
                    <button onclick="dismissPermissionsBanner()" class="w-8 h-8 flex items-center justify-center text-white/70 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-lg mx-auto min-h-screen flex flex-col pb-8">

        <!-- HEADER -->
        <header class="p-6 pt-8">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-black text-white tracking-tight">
                        FIELDVOICE<span class="text-indigo-400">PRO</span>
                    </h1>
                    <p id="currentDate" class="text-sm font-medium text-white/50 mt-1"></p>
                </div>
                <button onclick="openSettings()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white/50 hover:bg-white/20 transition-colors">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <!-- PROJECT CARD -->
        <section class="px-6 mb-6">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-5 border border-white/10">
                <div class="flex items-start gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-indigo-500/30 flex items-center justify-center text-indigo-300">
                        <i class="fas fa-hard-hat text-lg"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest mb-1">Active Project</p>
                        <h2 id="projectName" class="text-lg font-bold text-white leading-tight truncate"></h2>
                        <p id="contractDay" class="text-sm text-white/50 mt-1"></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- WEATHER CARD -->
        <section class="px-6 mb-6">
            <div class="bg-gradient-to-br from-sky-500/20 to-indigo-500/20 backdrop-blur-sm rounded-3xl p-5 border border-white/10">
                <div class="flex items-center justify-between mb-4">
                    <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Today's Weather</p>
                    <button id="syncWeatherBtn" onclick="syncWeather()" class="text-xs text-indigo-300 font-bold flex items-center gap-1 hover:text-indigo-200 transition-colors">
                        <i id="syncIcon" class="fas fa-sync-alt text-[10px]"></i>
                        Sync
                    </button>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-center">
                        <i id="weatherIcon" class="fas fa-sun text-4xl text-amber-400 animate-float"></i>
                    </div>
                    <div class="flex-1">
                        <p id="weatherCondition" class="text-xl font-bold text-white">Loading...</p>
                        <div class="flex gap-4 mt-1">
                            <span id="weatherTemp" class="text-sm text-white/70"><i class="fas fa-thermometer-half mr-1"></i>--/--</span>
                            <span id="weatherPrecip" class="text-sm text-white/70"><i class="fas fa-tint mr-1"></i>0.00"</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TODAY'S REPORT STATUS -->
        <section class="px-6 mb-6">
            <div id="reportStatusCard" class="bg-white/5 backdrop-blur-sm rounded-3xl p-5 border border-white/10">
                <!-- Dynamic content based on report status -->
            </div>
        </section>

        <!-- MAIN ACTION BUTTON -->
        <section class="px-6 flex-1 flex items-end">
            <button id="mainActionBtn" onclick="handleMainAction()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-3xl p-6 shadow-2xl shadow-indigo-500/30 hover:shadow-indigo-500/50 active:scale-[0.98] transition-all">
                <div class="flex items-center justify-center gap-4">
                    <div class="w-14 h-14 rounded-full bg-white/20 flex items-center justify-center">
                        <i id="mainActionIcon" class="fas fa-microphone text-2xl"></i>
                    </div>
                    <div class="text-left">
                        <p id="mainActionTitle" class="text-xl font-black">Start Today's Report</p>
                        <p id="mainActionSubtitle" class="text-sm text-white/70">5-minute voice interview</p>
                    </div>
                </div>
            </button>
        </section>

        <!-- QUICK ACTIONS -->
        <section class="px-6 mt-6">
            <div class="flex gap-3">
                <a href="report.html" id="viewReportBtn" class="hidden flex-1 bg-white/10 backdrop-blur-sm rounded-2xl p-4 text-center border border-white/10 hover:bg-white/20 transition-colors">
                    <i class="fas fa-file-alt text-white/50 text-lg mb-2"></i>
                    <p class="text-xs font-bold text-white/70">View Report</p>
                </a>
                <a href="editor.html?section=photos" class="flex-1 bg-white/10 backdrop-blur-sm rounded-2xl p-4 text-center border border-white/10 hover:bg-white/20 transition-colors">
                    <i class="fas fa-camera text-white/50 text-lg mb-2"></i>
                    <p class="text-xs font-bold text-white/70">Quick Photo</p>
                </a>
                <button onclick="viewHistory()" class="flex-1 bg-white/10 backdrop-blur-sm rounded-2xl p-4 text-center border border-white/10 hover:bg-white/20 transition-colors">
                    <i class="fas fa-history text-white/50 text-lg mb-2"></i>
                    <p class="text-xs font-bold text-white/70">History</p>
                </button>
            </div>
        </section>

        <!-- YESTERDAY CARRY-FORWARD BANNER -->
        <section id="carryForwardBanner" class="hidden px-6 mt-6">
            <div class="bg-amber-500/20 backdrop-blur-sm rounded-2xl p-4 border border-amber-500/30">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-amber-500/30 flex items-center justify-center">
                        <i class="fas fa-history text-amber-400"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-bold text-amber-300">Yesterday's data available</p>
                        <p class="text-xs text-amber-200/70">Contractors and equipment will carry forward</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- REPORT TYPE SELECTION MODAL -->
    <div id="reportTypeModal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-6">
        <div class="bg-slate-800 rounded-3xl w-full max-w-sm p-6">
            <div class="text-center mb-6">
                <h2 class="text-xl font-black text-white mb-2">Choose Report Type</h2>
                <p class="text-sm text-white/50">Select the type of report you want to create</p>
            </div>

            <div class="space-y-3">
                <!-- Quick Report Option -->
                <button onclick="startQuickReport()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl p-5 text-left hover:shadow-lg hover:shadow-emerald-500/20 transition-all">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                            <i class="fas fa-bolt text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-bold text-white text-lg">Quick Report</p>
                            <p class="text-sm text-white/70">Essential info only (~3 min)</p>
                        </div>
                        <i class="fas fa-chevron-right text-white/50"></i>
                    </div>
                </button>

                <!-- Full Report Option -->
                <button onclick="startFullReport()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl p-5 text-left hover:shadow-lg hover:shadow-indigo-500/20 transition-all">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                            <i class="fas fa-clipboard-list text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-bold text-white text-lg">Full Report</p>
                            <p class="text-sm text-white/70">Complete daily report (~5 min)</p>
                        </div>
                        <i class="fas fa-chevron-right text-white/50"></i>
                    </div>
                </button>
            </div>

            <button onclick="closeReportTypeModal()" class="w-full mt-4 p-3 text-white/50 hover:text-white/80 transition-colors text-sm font-medium">
                Cancel
            </button>
        </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="historyModal" class="hidden fixed inset-0 bg-black/90 z-50 overflow-y-auto">
        <div class="max-w-lg mx-auto p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-white">Report History</h2>
                <button onclick="closeHistory()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white/70">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="historyList" class="space-y-3">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        // ============ CONFIGURATION ============
        const INITIAL_OVERVIEW = {
            projectName: "North-South Connector Road Phase 2",
            noabProjectNo: "1291",
            cnoSolicitationNo: "N/A",
            noticeToProceed: "June 27th, 2025",
            contractDuration: "467 days",
            expectedCompletion: "October 7th, 2026",
            contractDayNo: calculateContractDay(),
            weatherDays: "0 days",
            date: new Date().toLocaleDateString(),
            location: "Louis Armstrong New Orleans Int'l Airport",
            engineer: "Garver, LLC",
            contractor: "Hunt, Gibbs, Boh, & Metro (HGBM)",
            startTime: "6:00 AM",
            endTime: "4:00 PM",
            shiftDuration: "10.00 hours",
            completedBy: "Inspector Name, RPR",
            weather: {
                highTemp: "--",
                lowTemp: "--",
                precipitation: "0.00\"",
                generalCondition: "Syncing...",
                jobSiteCondition: "Dry",
                adverseConditions: "N/A",
            },
        };

        function calculateContractDay() {
            const ntp = new Date('2025-06-27');
            const today = new Date();
            const diffTime = Math.abs(today - ntp);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return `Day ${diffDays} of 467`;
        }

        // ============ STORAGE ============
        function getTodayKey() {
            return `fieldvoice_report_${new Date().toISOString().split('T')[0]}`;
        }

        function getYesterdayKey() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return `fieldvoice_report_${yesterday.toISOString().split('T')[0]}`;
        }

        function getReport() {
            const saved = localStorage.getItem(getTodayKey());
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    return null;
                }
            }
            // Try legacy key
            const legacy = localStorage.getItem('fieldvoice_report');
            if (legacy) {
                try {
                    const parsed = JSON.parse(legacy);
                    // Check if it's from today
                    if (parsed.overview?.date === new Date().toLocaleDateString()) {
                        return parsed;
                    }
                } catch (e) {}
            }
            return null;
        }

        function hasYesterdayReport() {
            const saved = localStorage.getItem(getYesterdayKey());
            if (saved) return true;
            // Check legacy
            const legacy = localStorage.getItem('fieldvoice_report');
            if (legacy) {
                try {
                    const parsed = JSON.parse(legacy);
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    if (parsed.overview?.date === yesterday.toLocaleDateString()) {
                        return true;
                    }
                } catch (e) {}
            }
            return false;
        }

        function getReportHistory() {
            const history = [];
            const keys = Object.keys(localStorage).filter(k => k.startsWith('fieldvoice_report_'));
            keys.sort().reverse(); // Most recent first

            for (const key of keys.slice(0, 30)) { // Last 30 days
                try {
                    const report = JSON.parse(localStorage.getItem(key));
                    if (report) {
                        history.push({
                            key: key,
                            date: report.overview?.date || key.replace('fieldvoice_report_', ''),
                            projectName: report.overview?.projectName || 'Unknown Project',
                            completed: report.meta?.interviewCompleted || false,
                            contractorCount: report.contractors?.length || 0
                        });
                    }
                } catch (e) {}
            }
            return history;
        }

        function saveReport(report) {
            localStorage.setItem(getTodayKey(), JSON.stringify(report));
            localStorage.setItem('fieldvoice_report', JSON.stringify(report));
        }

        // ============ WEATHER ============
        async function syncWeather() {
            const syncIcon = document.getElementById('syncIcon');
            const syncBtn = document.getElementById('syncWeatherBtn');
            syncIcon.classList.add('fa-spin');

            try {
                // Check if geolocation is available
                if (!navigator.geolocation) {
                    throw { code: -1, message: 'Geolocation not supported' };
                }

                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        { timeout: 10000, enableHighAccuracy: false, maximumAge: 300000 } // Cache for 5 min
                    );
                });

                // Location success - update localStorage
                localStorage.setItem('fvp_loc_granted', 'true');

                const { latitude, longitude } = position.coords;
                console.log('Weather sync - got location:', { latitude, longitude });

                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto&temperature_unit=fahrenheit&precipitation_unit=inch`
                );

                if (!response.ok) {
                    throw new Error(`Weather API error: ${response.status}`);
                }

                const data = await response.json();

                const weatherCodes = {
                    0: { text: 'Clear', icon: 'fa-sun', color: 'text-amber-400' },
                    1: { text: 'Mostly Clear', icon: 'fa-sun', color: 'text-amber-400' },
                    2: { text: 'Partly Cloudy', icon: 'fa-cloud-sun', color: 'text-amber-300' },
                    3: { text: 'Overcast', icon: 'fa-cloud', color: 'text-slate-300' },
                    45: { text: 'Fog', icon: 'fa-smog', color: 'text-slate-400' },
                    48: { text: 'Fog', icon: 'fa-smog', color: 'text-slate-400' },
                    51: { text: 'Light Drizzle', icon: 'fa-cloud-rain', color: 'text-blue-300' },
                    53: { text: 'Drizzle', icon: 'fa-cloud-rain', color: 'text-blue-300' },
                    55: { text: 'Heavy Drizzle', icon: 'fa-cloud-showers-heavy', color: 'text-blue-400' },
                    61: { text: 'Light Rain', icon: 'fa-cloud-rain', color: 'text-blue-400' },
                    63: { text: 'Rain', icon: 'fa-cloud-showers-heavy', color: 'text-blue-500' },
                    65: { text: 'Heavy Rain', icon: 'fa-cloud-showers-heavy', color: 'text-blue-600' },
                    80: { text: 'Showers', icon: 'fa-cloud-showers-heavy', color: 'text-blue-500' },
                    95: { text: 'Thunderstorm', icon: 'fa-bolt', color: 'text-yellow-400' }
                };

                const weatherInfo = weatherCodes[data.current_weather.weathercode] || { text: 'Cloudy', icon: 'fa-cloud', color: 'text-slate-300' };
                const highTemp = Math.round(data.daily.temperature_2m_max[0]);
                const lowTemp = Math.round(data.daily.temperature_2m_min[0]);
                const precip = data.daily.precipitation_sum[0].toFixed(2);

                // Update UI
                document.getElementById('weatherCondition').textContent = weatherInfo.text;
                document.getElementById('weatherTemp').innerHTML = `<i class="fas fa-thermometer-half mr-1"></i>${highTemp}°/${lowTemp}°F`;
                document.getElementById('weatherPrecip').innerHTML = `<i class="fas fa-tint mr-1"></i>${precip}"`;
                document.getElementById('weatherIcon').className = `fas ${weatherInfo.icon} text-4xl ${weatherInfo.color} animate-float`;

                // Save to report if exists
                let report = getReport();
                if (report) {
                    report.overview.weather = {
                        highTemp: `${highTemp}°F`,
                        lowTemp: `${lowTemp}°F`,
                        precipitation: `${precip}"`,
                        generalCondition: weatherInfo.text,
                        jobSiteCondition: precip > 0.1 ? 'Wet' : 'Dry',
                        adverseConditions: precip > 0.25 ? 'Rain impact possible' : 'N/A'
                    };
                    saveReport(report);
                }
            } catch (error) {
                console.error('Weather sync failed:', error);

                // Handle different error types
                if (error.code === 1) {
                    // PERMISSION_DENIED
                    localStorage.removeItem('fvp_loc_granted');
                    localStorage.removeItem('fvp_loc_date');
                    document.getElementById('weatherCondition').textContent = 'Location blocked';
                    document.getElementById('weatherIcon').className = 'fas fa-location-crosshairs text-4xl text-red-400';

                    // Show a helpful message
                    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                        syncBtn.innerHTML = '<i id="syncIcon" class="fas fa-exclamation-triangle text-[10px] text-red-400"></i><span class="text-red-300">Fix in Settings</span>';
                        syncBtn.onclick = () => window.location.href = 'permissions.html';
                    } else {
                        syncBtn.innerHTML = '<i id="syncIcon" class="fas fa-lock text-[10px] text-red-400"></i><span class="text-red-300">Enable Location</span>';
                        syncBtn.onclick = () => window.location.href = 'permissions.html';
                    }
                } else if (error.code === 2) {
                    // POSITION_UNAVAILABLE
                    document.getElementById('weatherCondition').textContent = 'GPS unavailable';
                    document.getElementById('weatherIcon').className = 'fas fa-satellite-dish text-4xl text-amber-400';
                } else if (error.code === 3) {
                    // TIMEOUT
                    document.getElementById('weatherCondition').textContent = 'Location timeout';
                    document.getElementById('weatherIcon').className = 'fas fa-clock text-4xl text-amber-400';
                } else if (error.code === -1) {
                    // Not supported
                    document.getElementById('weatherCondition').textContent = 'Not supported';
                    document.getElementById('weatherIcon').className = 'fas fa-times-circle text-4xl text-gray-400';
                } else {
                    // API or network error
                    document.getElementById('weatherCondition').textContent = 'Sync failed';
                    document.getElementById('weatherIcon').className = 'fas fa-exclamation-triangle text-4xl text-amber-400';
                }
            }

            // Re-query the sync icon in case it was replaced
            const updatedSyncIcon = document.getElementById('syncIcon');
            if (updatedSyncIcon) {
                updatedSyncIcon.classList.remove('fa-spin');
            }
        }

        // ============ UI UPDATES ============
        function updateReportStatus() {
            const report = getReport();
            const statusCard = document.getElementById('reportStatusCard');
            const mainActionBtn = document.getElementById('mainActionBtn');
            const mainActionIcon = document.getElementById('mainActionIcon');
            const mainActionTitle = document.getElementById('mainActionTitle');
            const mainActionSubtitle = document.getElementById('mainActionSubtitle');
            const viewReportBtn = document.getElementById('viewReportBtn');

            if (!report) {
                // No report started
                statusCard.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-indigo-500/30 flex items-center justify-center">
                            <i class="fas fa-clipboard-list text-indigo-300 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-white">No report started</p>
                            <p class="text-xs text-white/50">Tap below to begin today's daily report</p>
                        </div>
                    </div>
                `;
                mainActionIcon.className = 'fas fa-microphone text-2xl';
                mainActionTitle.textContent = "Start Today's Report";
                mainActionSubtitle.textContent = "5-minute voice interview";
                viewReportBtn.classList.add('hidden');
            } else if (report.meta?.interviewCompleted) {
                // Report completed
                const contractorCount = report.contractors?.length || 0;
                const photoCount = report.photos?.length || 0;

                statusCard.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-emerald-500/30 flex items-center justify-center">
                            <i class="fas fa-check text-emerald-400 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-white">Report Complete</p>
                            <p class="text-xs text-white/50">${contractorCount} contractors · ${photoCount} photos</p>
                        </div>
                        <a href="report.html" class="px-4 py-2 bg-emerald-500 text-white rounded-xl text-sm font-bold hover:bg-emerald-400 transition-colors">
                            View
                        </a>
                    </div>
                `;
                mainActionIcon.className = 'fas fa-edit text-2xl';
                mainActionTitle.textContent = "Continue Editing";
                mainActionSubtitle.textContent = "Add more details or photos";
                viewReportBtn.classList.remove('hidden');
                viewReportBtn.classList.add('flex');
            } else {
                // Report in progress
                const progress = calculateProgress(report);
                const currentStep = report.meta?.currentStep || 0;
                const stepNames = ['Weather', 'Site Conditions', 'Contractors', 'Work Details', 'Headcounts', 'Equipment', 'Issues', 'Inspections', 'Safety', 'Visitors', 'Photos'];
                const currentStepName = stepNames[currentStep] || 'Starting';

                statusCard.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-amber-500/30 flex items-center justify-center">
                            <i class="fas fa-clipboard-list text-amber-400 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-white">Report In Progress</p>
                            <p class="text-xs text-white/40 mt-0.5">Next: ${currentStepName}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <div class="flex-1 h-1.5 bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-amber-400 to-emerald-400 rounded-full transition-all" style="width: ${progress}%"></div>
                                </div>
                                <span class="text-xs text-white/50">${progress}%</span>
                            </div>
                        </div>
                    </div>
                `;
                mainActionIcon.className = 'fas fa-play text-2xl';
                mainActionTitle.textContent = "Continue Interview";
                mainActionSubtitle.textContent = `Resume at ${currentStepName}`;
                viewReportBtn.classList.remove('hidden');
                viewReportBtn.classList.add('flex');
            }
        }

        function calculateProgress(report) {
            let filled = 0;
            let total = 8;

            if (report.overview?.weather?.generalCondition && report.overview.weather.generalCondition !== 'Syncing...') filled++;
            if (report.contractors?.length > 0) filled++;
            if (report.activities?.length > 0) filled++;
            if (report.operations?.length > 0) filled++;
            if (report.equipment?.length > 0) filled++;
            if (report.generalIssues?.length > 0 || report.meta?.issuesSkipped) filled++;
            if (report.qaqcNotes?.length > 0 || report.meta?.qaqcSkipped) filled++;
            if (report.safety?.notes?.length > 0) filled++;

            return Math.round((filled / total) * 100);
        }

        // ============ ACTIONS ============
        function handleMainAction() {
            const report = getReport();
            if (report && report.meta?.interviewCompleted) {
                // If report is completed, go to the appropriate interview page
                if (report.meta?.reportType === 'quick') {
                    window.location.href = 'quick-interview.html';
                } else {
                    window.location.href = 'interview.html';
                }
            } else if (report) {
                // Continue existing report
                if (report.meta?.reportType === 'quick') {
                    window.location.href = 'quick-interview.html';
                } else {
                    window.location.href = 'interview.html';
                }
            } else {
                // Show report type selection modal for new reports
                document.getElementById('reportTypeModal').classList.remove('hidden');
            }
        }

        function closeReportTypeModal() {
            document.getElementById('reportTypeModal').classList.add('hidden');
        }

        function startQuickReport() {
            closeReportTypeModal();
            window.location.href = 'quick-interview.html';
        }

        function startFullReport() {
            closeReportTypeModal();
            window.location.href = 'interview.html';
        }

        function viewHistory() {
            const modal = document.getElementById('historyModal');
            const list = document.getElementById('historyList');

            const history = getReportHistory();

            if (history.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-4xl text-white/20 mb-4"></i>
                        <p class="text-white/50">No report history yet</p>
                    </div>
                `;
            } else {
                list.innerHTML = history.map(h => `
                    <a href="report.html?key=${h.key}" class="block bg-white/10 rounded-2xl p-4 hover:bg-white/20 transition-colors">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full ${h.completed ? 'bg-emerald-500/30' : 'bg-amber-500/30'} flex items-center justify-center">
                                <i class="fas ${h.completed ? 'fa-check text-emerald-400' : 'fa-clock text-amber-400'}"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-bold text-white truncate">${h.projectName}</p>
                                <p class="text-xs text-white/50">${h.date} · ${h.contractorCount} contractors</p>
                            </div>
                            <i class="fas fa-chevron-right text-white/30"></i>
                        </div>
                    </a>
                `).join('');
            }

            modal.classList.remove('hidden');
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        function openSettings() {
            window.location.href = 'settings.html';
        }

        // ============ PERMISSIONS ============
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOSSafari = isIOS && isSafari;
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        function checkPermissionState() {
            const micGranted = localStorage.getItem('fvp_mic_granted') === 'true';
            const locGranted = localStorage.getItem('fvp_loc_granted') === 'true';
            const onboarded = localStorage.getItem('fvp_onboarded') === 'true';
            const bannerDismissed = localStorage.getItem('fvp_banner_dismissed') === 'true';
            const bannerDismissedDate = localStorage.getItem('fvp_banner_dismissed_date');

            // Reset banner dismissal after 24 hours
            if (bannerDismissedDate) {
                const dismissedTime = new Date(bannerDismissedDate).getTime();
                const now = new Date().getTime();
                const hoursSinceDismissal = (now - dismissedTime) / (1000 * 60 * 60);
                if (hoursSinceDismissal > 24) {
                    localStorage.removeItem('fvp_banner_dismissed');
                    localStorage.removeItem('fvp_banner_dismissed_date');
                }
            }

            return {
                micGranted,
                locGranted,
                onboarded,
                bannerDismissed: localStorage.getItem('fvp_banner_dismissed') === 'true',
                allGranted: micGranted && locGranted
            };
        }

        function shouldShowOnboarding() {
            const state = checkPermissionState();
            // Show onboarding on first visit if on mobile and permissions not granted
            if (isMobile && !state.onboarded && !state.allGranted) {
                return true;
            }
            return false;
        }

        function shouldShowBanner() {
            const state = checkPermissionState();
            // Show banner if:
            // 1. On mobile
            // 2. Onboarding was completed (or skipped)
            // 3. At least one permission is missing
            // 4. Banner wasn't dismissed recently
            if (isMobile && state.onboarded && !state.allGranted && !state.bannerDismissed) {
                return true;
            }
            return false;
        }

        function showPermissionsBanner() {
            const state = checkPermissionState();
            const banner = document.getElementById('permissionsBanner');
            const bannerText = document.getElementById('permissionsBannerText');

            if (!state.micGranted && !state.locGranted) {
                bannerText.textContent = 'Enable mic & location for full features';
            } else if (!state.micGranted) {
                bannerText.textContent = 'Enable microphone for voice notes';
            } else if (!state.locGranted) {
                bannerText.textContent = 'Enable location for weather & GPS';
            }

            banner.classList.remove('hidden');
        }

        function dismissPermissionsBanner() {
            const banner = document.getElementById('permissionsBanner');
            banner.classList.add('hidden');
            localStorage.setItem('fvp_banner_dismissed', 'true');
            localStorage.setItem('fvp_banner_dismissed_date', new Date().toISOString());
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => {
            // Check if first-time user needs permissions onboarding
            if (shouldShowOnboarding()) {
                window.location.href = 'permissions.html';
                return;
            }

            // Show permissions banner if needed
            if (shouldShowBanner()) {
                showPermissionsBanner();
            }

            // Set date
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });

            // Set project info
            document.getElementById('projectName').textContent = INITIAL_OVERVIEW.projectName;
            document.getElementById('contractDay').textContent = INITIAL_OVERVIEW.contractDayNo;

            // Check for yesterday's report
            if (hasYesterdayReport()) {
                document.getElementById('carryForwardBanner').classList.remove('hidden');
            }

            // Update report status
            updateReportStatus();

            // Sync weather
            syncWeather();
        });
    </script>
</body>
</html>
