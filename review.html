<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Review Report - FieldVoice Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e1b4b 100%);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .loading-shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .typing-effect {
            animation: fadeIn 0.3s ease-in;
        }
        .editable-area {
            min-height: 60px;
            outline: none;
            border-radius: 8px;
            padding: 8px;
            transition: background-color 0.2s;
        }
        .editable-area:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .editable-area:focus {
            background-color: rgba(255,255,255,0.1);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
        }
        .editable-area[data-placeholder]:empty:before {
            content: attr(data-placeholder);
            color: rgba(255,255,255,0.3);
            font-style: italic;
        }
        .section-na {
            opacity: 0.6;
        }
        .section-na .refine-btn {
            display: none;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div id="app" class="max-w-4xl mx-auto min-h-screen flex flex-col">

        <!-- HEADER -->
        <header class="sticky top-0 z-20 bg-slate-900/95 backdrop-blur-sm p-4 border-b border-white/10">
            <div class="flex items-center justify-between">
                <a href="quick-interview.html" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 transition-colors">
                    <i class="fas fa-arrow-left text-white/70"></i>
                </a>
                <div class="text-center flex-1 mx-4">
                    <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest">AI Review</p>
                    <p id="currentDate" class="text-sm font-medium text-white/70"></p>
                </div>
                <button onclick="saveAndExport()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold rounded-xl transition-colors">
                    <i class="fas fa-file-export mr-2"></i>Export
                </button>
            </div>
        </header>

        <!-- API KEY INPUT (Collapsible) -->
        <div id="apiKeySection" class="px-4 pt-4">
            <div class="bg-amber-500/20 border border-amber-500/30 rounded-2xl p-4">
                <div class="flex items-center gap-3 mb-3">
                    <i class="fas fa-key text-amber-400"></i>
                    <p class="font-bold text-amber-300">AI Refinement (Optional)</p>
                </div>
                <p class="text-xs text-amber-200/70 mb-3">Enter your Groq API key to enable AI text refinement. Get a free key at <a href="https://console.groq.com" target="_blank" class="underline">console.groq.com</a></p>
                <div class="flex gap-2">
                    <input type="password" id="apiKeyInput" class="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-2 text-sm text-white placeholder-white/40 focus:outline-none focus:border-amber-500" placeholder="gsk_...">
                    <button onclick="saveApiKey()" class="px-4 py-2 bg-amber-600 hover:bg-amber-500 text-white font-bold rounded-xl transition-colors">
                        Save
                    </button>
                </div>
                <p id="apiStatus" class="text-xs text-white/50 mt-2"></p>
            </div>
        </div>

        <!-- REFINE ALL BUTTON -->
        <div class="px-4 pt-4">
            <button id="refineAllBtn" onclick="refineAllSections()" class="w-full p-4 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 rounded-2xl font-bold text-white flex items-center justify-center gap-3 transition-all">
                <i class="fas fa-magic text-lg"></i>
                <span>Refine All with AI</span>
            </button>
        </div>

        <!-- SECTIONS LIST -->
        <main class="flex-1 p-4 pb-8 space-y-4 overflow-y-auto hide-scrollbar">

            <!-- Weather Section -->
            <div id="weather-section" class="bg-white/5 rounded-2xl border border-white/10 overflow-hidden" data-section="weather">
                <div class="p-4 border-b border-white/10 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-sky-500/20 flex items-center justify-center">
                        <i class="fas fa-cloud-sun text-sky-400"></i>
                    </div>
                    <p class="font-bold text-white flex-1">Weather & Site Conditions</p>
                    <button id="weather-refine-btn" onclick="refineSection('weather')" class="refine-btn px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg transition-colors">
                        <i class="fas fa-wand-magic-sparkles mr-1"></i>Refine
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-white/10">
                    <div class="p-4">
                        <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest mb-2">Original</p>
                        <div id="weather-original" class="text-sm text-white/70 min-h-[60px]">Loading...</div>
                    </div>
                    <div class="p-4 bg-emerald-500/5">
                        <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-2">
                            AI Refined <span class="text-white/30 font-normal">(click to edit)</span>
                        </p>
                        <div id="weather-refined" class="editable-area text-sm text-white" contenteditable="true" data-placeholder="Click 'Refine' to improve or type here to edit..." oninput="handleEdit('weather')"></div>
                    </div>
                </div>
            </div>

            <!-- Work Summary Section -->
            <div id="activities-section" class="bg-white/5 rounded-2xl border border-white/10 overflow-hidden" data-section="activities">
                <div class="p-4 border-b border-white/10 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center">
                        <i class="fas fa-tasks text-emerald-400"></i>
                    </div>
                    <p class="font-bold text-white flex-1">Work Summary</p>
                    <button id="activities-refine-btn" onclick="refineSection('activities')" class="refine-btn px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg transition-colors">
                        <i class="fas fa-wand-magic-sparkles mr-1"></i>Refine
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-white/10">
                    <div class="p-4">
                        <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest mb-2">Original</p>
                        <div id="activities-original" class="text-sm text-white/70 min-h-[60px]">Loading...</div>
                    </div>
                    <div class="p-4 bg-emerald-500/5">
                        <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-2">
                            AI Refined <span class="text-white/30 font-normal">(click to edit)</span>
                        </p>
                        <div id="activities-refined" class="editable-area text-sm text-white" contenteditable="true" data-placeholder="Click 'Refine' to improve or type here to edit..." oninput="handleEdit('activities')"></div>
                    </div>
                </div>
            </div>

            <!-- Issues Section -->
            <div id="issues-section" class="bg-white/5 rounded-2xl border border-white/10 overflow-hidden" data-section="issues">
                <div class="p-4 border-b border-white/10 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                    </div>
                    <p class="font-bold text-white flex-1">Issues & Delays</p>
                    <span id="issues-na-badge" class="hidden px-3 py-1.5 bg-white/10 text-white/50 text-xs font-bold rounded-lg">N/A</span>
                    <button id="issues-refine-btn" onclick="refineSection('issues')" class="refine-btn px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg transition-colors">
                        <i class="fas fa-wand-magic-sparkles mr-1"></i>Refine
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-white/10">
                    <div class="p-4">
                        <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest mb-2">Original</p>
                        <div id="issues-original" class="text-sm text-white/70 min-h-[60px]">Loading...</div>
                    </div>
                    <div class="p-4 bg-emerald-500/5">
                        <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-2">
                            AI Refined <span class="text-white/30 font-normal">(click to edit)</span>
                        </p>
                        <div id="issues-refined" class="editable-area text-sm text-white" contenteditable="true" data-placeholder="Click 'Refine' to improve or type here to edit..." oninput="handleEdit('issues')"></div>
                    </div>
                </div>
            </div>

            <!-- Inspections Section -->
            <div id="inspections-section" class="bg-white/5 rounded-2xl border border-white/10 overflow-hidden" data-section="inspections">
                <div class="p-4 border-b border-white/10 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center">
                        <i class="fas fa-check-double text-purple-400"></i>
                    </div>
                    <p class="font-bold text-white flex-1">QA/QC Inspections</p>
                    <span id="inspections-na-badge" class="hidden px-3 py-1.5 bg-white/10 text-white/50 text-xs font-bold rounded-lg">N/A</span>
                    <button id="inspections-refine-btn" onclick="refineSection('inspections')" class="refine-btn px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg transition-colors">
                        <i class="fas fa-wand-magic-sparkles mr-1"></i>Refine
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-white/10">
                    <div class="p-4">
                        <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest mb-2">Original</p>
                        <div id="inspections-original" class="text-sm text-white/70 min-h-[60px]">Loading...</div>
                    </div>
                    <div class="p-4 bg-emerald-500/5">
                        <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-2">
                            AI Refined <span class="text-white/30 font-normal">(click to edit)</span>
                        </p>
                        <div id="inspections-refined" class="editable-area text-sm text-white" contenteditable="true" data-placeholder="Click 'Refine' to improve or type here to edit..." oninput="handleEdit('inspections')"></div>
                    </div>
                </div>
            </div>

            <!-- Safety Section -->
            <div id="safety-section" class="bg-white/5 rounded-2xl border border-white/10 overflow-hidden" data-section="safety">
                <div class="p-4 border-b border-white/10 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-green-500/20 flex items-center justify-center">
                        <i class="fas fa-hard-hat text-green-400"></i>
                    </div>
                    <p class="font-bold text-white flex-1">Safety</p>
                    <button id="safety-refine-btn" onclick="refineSection('safety')" class="refine-btn px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg transition-colors">
                        <i class="fas fa-wand-magic-sparkles mr-1"></i>Refine
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-white/10">
                    <div class="p-4">
                        <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest mb-2">Original</p>
                        <div id="safety-original" class="text-sm text-white/70 min-h-[60px]">Loading...</div>
                    </div>
                    <div class="p-4 bg-emerald-500/5">
                        <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-2">
                            AI Refined <span class="text-white/30 font-normal">(click to edit)</span>
                        </p>
                        <div id="safety-refined" class="editable-area text-sm text-white" contenteditable="true" data-placeholder="Click 'Refine' to improve or type here to edit..." oninput="handleEdit('safety')"></div>
                    </div>
                </div>
            </div>

            <!-- Visitors Section -->
            <div id="visitors-section" class="bg-white/5 rounded-2xl border border-white/10 overflow-hidden" data-section="visitors">
                <div class="p-4 border-b border-white/10 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-indigo-500/20 flex items-center justify-center">
                        <i class="fas fa-user-tie text-indigo-400"></i>
                    </div>
                    <p class="font-bold text-white flex-1">Visitors & Communications</p>
                    <span id="visitors-na-badge" class="hidden px-3 py-1.5 bg-white/10 text-white/50 text-xs font-bold rounded-lg">N/A</span>
                    <button id="visitors-refine-btn" onclick="refineSection('visitors')" class="refine-btn px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg transition-colors">
                        <i class="fas fa-wand-magic-sparkles mr-1"></i>Refine
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-white/10">
                    <div class="p-4">
                        <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest mb-2">Original</p>
                        <div id="visitors-original" class="text-sm text-white/70 min-h-[60px]">Loading...</div>
                    </div>
                    <div class="p-4 bg-emerald-500/5">
                        <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-2">
                            AI Refined <span class="text-white/30 font-normal">(click to edit)</span>
                        </p>
                        <div id="visitors-refined" class="editable-area text-sm text-white" contenteditable="true" data-placeholder="Click 'Refine' to improve or type here to edit..." oninput="handleEdit('visitors')"></div>
                    </div>
                </div>
            </div>

            <!-- Photos Section -->
            <div class="bg-white/5 rounded-2xl border border-white/10 overflow-hidden" data-section="photos">
                <div class="p-4 border-b border-white/10 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-pink-500/20 flex items-center justify-center">
                        <i class="fas fa-camera text-pink-400"></i>
                    </div>
                    <p class="font-bold text-white flex-1">Progress Photos</p>
                </div>
                <div class="p-4">
                    <div id="photos-grid" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <!-- Dynamic photos -->
                    </div>
                </div>
            </div>

        </main>

        <!-- BOTTOM ACTION -->
        <div class="sticky bottom-0 p-4 bg-slate-900/95 backdrop-blur-sm border-t border-white/10">
            <div class="flex gap-3">
                <button onclick="saveAndViewReport()" class="flex-1 p-4 bg-emerald-600 hover:bg-emerald-500 rounded-2xl text-center font-bold text-white transition-colors">
                    <i class="fas fa-save mr-2"></i>Save & View Report
                </button>
                <button onclick="copyToClipboard()" class="px-6 py-4 bg-indigo-600 hover:bg-indigo-500 rounded-2xl font-bold text-white transition-colors">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============ STATE ============
        let report = null;
        let refinedData = {};
        let apiKey = '';
        let naSections = {};

        // ============ STORAGE ============
        function getTodayKey() {
            return `fieldvoice_report_${new Date().toISOString().split('T')[0]}`;
        }

        function getReport() {
            const saved = localStorage.getItem(getTodayKey());
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Ensure required properties exist for legacy reports
                    if (!parsed.meta) parsed.meta = {};
                    if (!parsed.meta.naMarked) parsed.meta.naMarked = {};
                    if (!parsed.safety) parsed.safety = { hasIncidents: false, noIncidents: false, notes: [] };
                    if (parsed.safety.noIncidents === undefined) parsed.safety.noIncidents = false;
                    if (!parsed.refinedData) parsed.refinedData = {};
                    return parsed;
                } catch (e) {}
            }
            const legacy = localStorage.getItem('fieldvoice_report');
            if (legacy) {
                try {
                    const parsed = JSON.parse(legacy);
                    // Ensure required properties exist for legacy reports
                    if (!parsed.meta) parsed.meta = {};
                    if (!parsed.meta.naMarked) parsed.meta.naMarked = {};
                    if (!parsed.safety) parsed.safety = { hasIncidents: false, noIncidents: false, notes: [] };
                    if (parsed.safety.noIncidents === undefined) parsed.safety.noIncidents = false;
                    if (!parsed.refinedData) parsed.refinedData = {};
                    return parsed;
                } catch (e) {}
            }
            return null;
        }

        function saveReport() {
            localStorage.setItem(getTodayKey(), JSON.stringify(report));
            localStorage.setItem('fieldvoice_report', JSON.stringify(report));
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                localStorage.setItem('groq_api_key', key);
                apiKey = key;
                document.getElementById('apiStatus').textContent = 'API key saved!';
                document.getElementById('apiStatus').className = 'text-xs text-emerald-400 mt-2';
                setTimeout(() => {
                    document.getElementById('apiStatus').textContent = '';
                }, 3000);
            }
        }

        function loadApiKey() {
            const saved = localStorage.getItem('groq_api_key');
            if (saved) {
                apiKey = saved;
                document.getElementById('apiKeyInput').value = saved;
                document.getElementById('apiStatus').textContent = 'API key loaded from storage';
                document.getElementById('apiStatus').className = 'text-xs text-white/50 mt-2';
            }
        }

        // ============ HANDLE EDITS ============
        function handleEdit(section) {
            const refinedEl = document.getElementById(`${section}-refined`);
            const text = refinedEl.innerText.trim();
            refinedData[section] = text;
            // Auto-save on edit
            saveRefinedDataToReport();
        }

        function saveRefinedDataToReport() {
            if (!report) return;

            // Initialize refined data storage if needed
            if (!report.refinedData) {
                report.refinedData = {};
            }

            // Save all refined data
            Object.keys(refinedData).forEach(section => {
                if (refinedData[section]) {
                    report.refinedData[section] = refinedData[section];
                }
            });

            saveReport();
        }

        // ============ DISPLAY ORIGINAL DATA ============
        function displayOriginalData() {
            if (!report) return;

            const naMarked = report.meta?.naMarked || {};

            // Weather
            const weatherText = report.overview?.weather?.jobSiteCondition ||
                `${report.overview?.weather?.generalCondition || 'N/A'}, High: ${report.overview?.weather?.highTemp || '--'}, Low: ${report.overview?.weather?.lowTemp || '--'}`;
            document.getElementById('weather-original').textContent = weatherText || 'No weather data';

            // Activities
            const activitiesText = report.activities?.map(a => a.narrative).join('\n\n') || 'No activities recorded';
            document.getElementById('activities-original').innerHTML = activitiesText.replace(/\n/g, '<br>') || '<span class="text-white/40 italic">No data</span>';

            // Issues - check for N/A
            if (naMarked.issues) {
                naSections.issues = true;
                document.getElementById('issues-section').classList.add('section-na');
                document.getElementById('issues-na-badge').classList.remove('hidden');
                document.getElementById('issues-refine-btn').classList.add('hidden');
                document.getElementById('issues-original').innerHTML = '<span class="text-white/40 italic">N/A - No issues reported</span>';
                document.getElementById('issues-refined').innerHTML = '<span class="text-white/40 italic">N/A</span>';
                document.getElementById('issues-refined').contentEditable = 'false';
            } else {
                const issuesText = report.generalIssues?.join('\n\n') || 'No issues recorded';
                document.getElementById('issues-original').innerHTML = issuesText.replace(/\n/g, '<br>') || '<span class="text-white/40 italic">No data</span>';
            }

            // Inspections - check for N/A
            if (naMarked.inspections) {
                naSections.inspections = true;
                document.getElementById('inspections-section').classList.add('section-na');
                document.getElementById('inspections-na-badge').classList.remove('hidden');
                document.getElementById('inspections-refine-btn').classList.add('hidden');
                document.getElementById('inspections-original').innerHTML = '<span class="text-white/40 italic">N/A - No inspections</span>';
                document.getElementById('inspections-refined').innerHTML = '<span class="text-white/40 italic">N/A</span>';
                document.getElementById('inspections-refined').contentEditable = 'false';
            } else {
                const inspectionsText = report.qaqcNotes?.join('\n\n') || 'No inspections recorded';
                document.getElementById('inspections-original').innerHTML = inspectionsText.replace(/\n/g, '<br>') || '<span class="text-white/40 italic">No data</span>';
            }

            // Safety
            let safetyText = '';
            if (report.safety?.hasIncidents) {
                safetyText = 'INCIDENT REPORTED\n\n';
            } else if (report.safety?.noIncidents) {
                safetyText = 'No incidents reported.\n\n';
            }
            safetyText += report.safety?.notes?.join('\n\n') || '';
            document.getElementById('safety-original').innerHTML = safetyText.replace(/\n/g, '<br>') || '<span class="text-white/40 italic">No data</span>';

            // Visitors - check for N/A
            if (naMarked.visitors) {
                naSections.visitors = true;
                document.getElementById('visitors-section').classList.add('section-na');
                document.getElementById('visitors-na-badge').classList.remove('hidden');
                document.getElementById('visitors-refine-btn').classList.add('hidden');
                document.getElementById('visitors-original').innerHTML = '<span class="text-white/40 italic">N/A - No visitors</span>';
                document.getElementById('visitors-refined').innerHTML = '<span class="text-white/40 italic">N/A</span>';
                document.getElementById('visitors-refined').contentEditable = 'false';
            } else {
                const visitorsText = report.visitorsRemarks?.join('\n\n') || 'No visitors recorded';
                document.getElementById('visitors-original').innerHTML = visitorsText.replace(/\n/g, '<br>') || '<span class="text-white/40 italic">No data</span>';
            }

            // Photos
            const photosGrid = document.getElementById('photos-grid');
            if (report.photos?.length > 0) {
                photosGrid.innerHTML = report.photos.map((p, i) => `
                    <div class="relative bg-white/5 rounded-xl overflow-hidden">
                        <img src="${p.url}" class="w-full aspect-square object-cover">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2">
                            <p class="text-[10px] text-white/70">${p.time || ''}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                photosGrid.innerHTML = '<p class="text-white/40 italic col-span-full text-center py-4">No photos</p>';
            }

            // Load previously saved refined data
            if (report.refinedData) {
                Object.keys(report.refinedData).forEach(section => {
                    if (report.refinedData[section] && !naSections[section]) {
                        refinedData[section] = report.refinedData[section];
                        const refinedEl = document.getElementById(`${section}-refined`);
                        if (refinedEl) {
                            refinedEl.innerHTML = report.refinedData[section].replace(/\n/g, '<br>');
                        }
                    }
                });
            }
        }

        // ============ AI REFINEMENT ============
        async function refineSection(section) {
            // Check if section is N/A
            if (naSections[section]) {
                showToast('Cannot refine N/A sections');
                return;
            }

            if (!apiKey) {
                alert('Please enter your Groq API key first');
                document.getElementById('apiKeyInput').focus();
                return;
            }

            const originalEl = document.getElementById(`${section}-original`);
            const refinedEl = document.getElementById(`${section}-refined`);
            const originalText = originalEl.textContent;

            if (!originalText || originalText === 'No data' || originalText.includes('N/A') || originalText.includes('No ') && originalText.includes(' recorded')) {
                refinedEl.innerHTML = '<span class="text-white/40 italic">Nothing to refine</span>';
                return;
            }

            // Show loading state
            refinedEl.innerHTML = '<div class="loading-shimmer rounded p-4 h-16"></div>';
            refinedEl.contentEditable = 'false';

            try {
                const sectionPrompts = {
                    weather: 'Rewrite this weather and site conditions description in clear, professional language suitable for a construction daily report:',
                    activities: 'Rewrite this work summary in clear, professional language suitable for a construction daily report. Use proper grammar and professional terminology:',
                    issues: 'Rewrite this issues and delays description in clear, professional language suitable for a construction daily report. Be specific and actionable:',
                    inspections: 'Rewrite this QA/QC inspections note in clear, professional language suitable for a construction daily report:',
                    safety: 'Rewrite this safety report in clear, professional language suitable for a construction daily report. Maintain accuracy of any incident information:',
                    visitors: 'Rewrite this visitors and communications note in clear, professional language suitable for a construction daily report:'
                };

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instant',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a professional construction report writer. Rewrite the given text in clear, professional language while maintaining all factual information. Keep responses concise and suitable for official documentation. Do not add any information that was not in the original text.'
                            },
                            {
                                role: 'user',
                                content: `${sectionPrompts[section]}\n\n"${originalText}"`
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const refinedText = data.choices[0]?.message?.content || 'Error refining text';

                // Store refined data
                refinedData[section] = refinedText;

                // Display with typing effect and make editable again
                refinedEl.innerHTML = '';
                refinedEl.contentEditable = 'true';
                const p = document.createElement('span');
                p.className = 'typing-effect';
                p.innerHTML = refinedText.replace(/\n/g, '<br>');
                refinedEl.appendChild(p);

                // Save to report
                saveRefinedDataToReport();

            } catch (error) {
                console.error('Refinement error:', error);
                refinedEl.innerHTML = `<span class="text-red-400">Error: ${error.message}</span>`;
                refinedEl.contentEditable = 'true';
            }
        }

        async function refineAllSections() {
            const sections = ['weather', 'activities', 'issues', 'inspections', 'safety', 'visitors'];
            const btn = document.getElementById('refineAllBtn');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Refining...';

            for (const section of sections) {
                // Skip N/A sections
                if (naSections[section]) continue;

                await refineSection(section);
                // Small delay between API calls to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check mr-2"></i>All Refined!';

            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-magic text-lg"></i><span>Refine All with AI</span>';
            }, 3000);
        }

        // ============ SAVE & VIEW ============
        function saveAndViewReport() {
            // Save all current edits
            const sections = ['weather', 'activities', 'issues', 'inspections', 'safety', 'visitors'];
            sections.forEach(section => {
                if (!naSections[section]) {
                    const refinedEl = document.getElementById(`${section}-refined`);
                    const text = refinedEl.innerText.trim();
                    if (text && !text.includes('Click') && !text.includes('Nothing to refine')) {
                        refinedData[section] = text;
                    }
                }
            });

            saveRefinedDataToReport();
            showToast('Report saved!');

            setTimeout(() => {
                window.location.href = 'report.html';
            }, 500);
        }

        function saveAndExport() {
            // Save first
            saveRefinedDataToReport();

            let exportText = `DAILY REPORT - ${report?.overview?.date || new Date().toLocaleDateString()}\n`;
            exportText += `Project: ${report?.overview?.projectName || 'N/A'}\n`;
            exportText += `${'='.repeat(50)}\n\n`;

            const sections = [
                { id: 'weather', title: 'WEATHER & SITE CONDITIONS' },
                { id: 'activities', title: 'WORK SUMMARY' },
                { id: 'issues', title: 'ISSUES & DELAYS' },
                { id: 'inspections', title: 'QA/QC INSPECTIONS' },
                { id: 'safety', title: 'SAFETY' },
                { id: 'visitors', title: 'VISITORS & COMMUNICATIONS' }
            ];

            sections.forEach(section => {
                exportText += `${section.title}\n${'-'.repeat(section.title.length)}\n`;

                if (naSections[section.id]) {
                    exportText += 'N/A\n\n';
                } else {
                    const refined = refinedData[section.id];
                    const original = document.getElementById(`${section.id}-original`)?.textContent;
                    exportText += (refined || original || 'N/A') + '\n\n';
                }
            });

            // Create download
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `daily-report-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            let copyText = '';

            const sections = ['weather', 'activities', 'issues', 'inspections', 'safety', 'visitors'];
            sections.forEach(section => {
                if (naSections[section]) {
                    return; // Skip N/A sections
                }
                const refined = refinedData[section];
                const original = document.getElementById(`${section}-original`)?.textContent;
                if (refined || original) {
                    copyText += (refined || original) + '\n\n';
                }
            });

            navigator.clipboard.writeText(copyText).then(() => {
                showToast('Copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }

        function showToast(message) {
            const existing = document.querySelector('.toast-msg');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast-msg fixed bottom-24 left-1/2 -translate-x-1/2 bg-emerald-600 text-white px-6 py-3 rounded-full font-bold text-sm shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => {
            // Set date
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });

            // Load report
            report = getReport();

            if (!report) {
                document.querySelector('main').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-4xl text-white/20 mb-4"></i>
                        <p class="text-white/50">No report found</p>
                        <a href="index.html" class="inline-block mt-4 px-6 py-3 bg-indigo-600 rounded-xl font-bold text-white">Go to Dashboard</a>
                    </div>
                `;
                return;
            }

            // Load API key
            loadApiKey();

            // Display original data
            displayOriginalData();
        });
    </script>
</body>
</html>
